<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GEX Monitor â€” æœŸæƒGammaæš´éœ²ç›‘æ§</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg-0:#080b0f;--bg-1:#0d1117;--bg-2:#131922;--bg-3:#1a2332;
  --border:#1e2d42;--border-bright:#2a3f5a;
  --green:#00d084;--green-dim:#00d08440;--green-glow:#00d08420;
  --red:#ff4757;--red-dim:#ff475740;
  --yellow:#ffd32a;--yellow-dim:#ffd32a40;
  --blue:#1e90ff;--blue-dim:#1e90ff30;
  --purple:#a55eea;--cyan:#00d2d3;
  --text-primary:#e8edf5;--text-secondary:#8899aa;--text-dim:#4a5a6a;
  --font-mono:'JetBrains Mono',monospace;--font-display:'Syne',sans-serif;
  --radius:6px;--radius-lg:12px;--t:0.2s ease;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg-0);color:var(--text-primary);font-family:var(--font-mono);font-size:13px;line-height:1.5;min-height:100vh;overflow-x:hidden;}

/* Header */
header{position:sticky;top:0;z-index:100;background:var(--bg-1);border-bottom:1px solid var(--border);padding:0 24px;display:flex;align-items:center;justify-content:space-between;height:56px;}
.logo{font-family:var(--font-display);font-size:18px;font-weight:800;display:flex;align-items:center;gap:10px;}
.logo-dot{width:8px;height:8px;background:var(--green);border-radius:50%;box-shadow:0 0 8px var(--green);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:.6;transform:scale(.85);}}
.header-right{display:flex;align-items:center;gap:16px;}
.market-status{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text-secondary);}
.status-dot{width:6px;height:6px;border-radius:50%;background:var(--text-dim);}
.status-dot.active{background:var(--green);box-shadow:0 0 6px var(--green);}
.status-dot.closed{background:var(--red);}
#global-time{font-size:11px;color:var(--text-secondary);font-variant-numeric:tabular-nums;}

/* Tabs */
.tabs{display:flex;gap:2px;padding:12px 24px 0;border-bottom:1px solid var(--border);background:var(--bg-1);}
.tab-btn{background:none;border:none;padding:10px 20px;font-family:var(--font-display);font-size:13px;font-weight:600;color:var(--text-dim);cursor:pointer;border-bottom:2px solid transparent;transition:var(--t);text-transform:uppercase;letter-spacing:.5px;}
.tab-btn:hover{color:var(--text-secondary);}
.tab-btn.active{color:var(--green);border-bottom-color:var(--green);}
.tab-panel{display:none;padding:24px;}
.tab-panel.active{display:block;}

/* Cards / Rows */
.gex-section,.doomsday-section{display:flex;flex-direction:column;gap:20px;}
.symbol-row{display:flex;flex-direction:column;}

/* Input bar */
.symbol-input-bar{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-lg) var(--radius-lg) 0 0;padding:12px 20px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.symbol-num{font-family:var(--font-display);font-size:11px;font-weight:800;color:var(--text-dim);width:20px;text-align:center;text-transform:uppercase;}
.sym-input{background:var(--bg-3);border:1px solid var(--border);border-radius:var(--radius);padding:6px 12px;font-family:var(--font-mono);font-size:14px;font-weight:700;color:var(--text-primary);width:100px;text-transform:uppercase;letter-spacing:1px;outline:none;transition:var(--t);}
.sym-input:focus{border-color:var(--green);box-shadow:0 0 0 2px var(--green-glow);}
.load-btn{background:var(--green);color:#000;border:none;border-radius:var(--radius);padding:6px 16px;font-family:var(--font-display);font-size:12px;font-weight:700;cursor:pointer;text-transform:uppercase;transition:var(--t);}
.load-btn:hover{background:#00f0a0;transform:translateY(-1px);}
.load-btn:disabled{background:var(--bg-3);color:var(--text-dim);cursor:not-allowed;transform:none;}
.update-time{font-size:10px;color:var(--text-dim);margin-left:auto;}

/* Metrics bar */
.metrics-bar{display:flex;border-left:1px solid var(--border);border-right:1px solid var(--border);overflow-x:auto;scrollbar-width:none;}
.metric-item{flex:1;min-width:90px;padding:10px 14px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);background:var(--bg-1);}
.metric-item:last-child{border-right:none;}
.metric-label{font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:.8px;margin-bottom:4px;}
.metric-value{font-size:15px;font-weight:700;font-variant-numeric:tabular-nums;}
.metric-value.green{color:var(--green);}
.metric-value.red{color:var(--red);}
.metric-value.yellow{color:var(--yellow);}
.metric-value.blue{color:var(--blue);}

/* Expiry */
.expiry-section{border-left:1px solid var(--border);border-right:1px solid var(--border);}
.expiry-toggle{display:flex;align-items:center;justify-content:space-between;padding:10px 20px;background:var(--bg-2);border-bottom:1px solid var(--border);cursor:pointer;user-select:none;}
.expiry-toggle:hover{background:var(--bg-3);}
.expiry-toggle-label{font-size:12px;font-weight:600;color:var(--text-secondary);display:flex;align-items:center;gap:8px;font-family:var(--font-display);}
.selected-summary{font-size:11px;color:var(--green);}
.chevron{font-size:10px;color:var(--text-dim);transition:transform var(--t);}
.chevron.open{transform:rotate(180deg);}
.expiry-content{display:none;padding:14px 20px;background:var(--bg-1);border-bottom:1px solid var(--border);}
.expiry-content.open{display:block;}
.expiry-grid{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;}
.expiry-chip{display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:4px;background:var(--bg-2);border:1px solid var(--border);font-size:11px;cursor:pointer;transition:var(--t);user-select:none;color:var(--text-secondary);}
.expiry-chip:hover{border-color:var(--border-bright);color:var(--text-primary);}
.expiry-chip.selected{background:var(--green-dim);border-color:var(--green);color:var(--green);}
.expiry-chip input[type=checkbox]{width:12px;height:12px;accent-color:var(--green);}
.expiry-actions{display:flex;gap:8px;}
.expiry-action-btn{background:none;border:1px solid var(--border);border-radius:var(--radius);padding:4px 10px;font-size:11px;color:var(--text-secondary);cursor:pointer;font-family:var(--font-mono);transition:var(--t);}
.expiry-action-btn:hover{border-color:var(--green);color:var(--green);}

/* Chart area */
.chart-area{border:1px solid var(--border);border-top:none;border-radius:0 0 var(--radius-lg) var(--radius-lg);background:var(--bg-1);padding:16px;}
.chart-wrap{position:relative;width:100%;}
.chart-loading{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg-1);z-index:10;gap:12px;}
.chart-loading.hidden{display:none;}
.spinner{width:28px;height:28px;border:2px solid var(--border);border-top-color:var(--green);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.loading-text{font-size:12px;color:var(--text-dim);text-align:center;padding:0 20px;}
.chart-controls{display:flex;align-items:center;justify-content:flex-end;gap:8px;margin-bottom:10px;}
.range-label{font-size:11px;color:var(--text-dim);}
.zoom-btn{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius);padding:3px 10px;font-size:11px;color:var(--text-secondary);cursor:pointer;font-family:var(--font-mono);transition:var(--t);}
.zoom-btn:hover{border-color:var(--green);color:var(--green);}
.zoom-btn.active{background:var(--green-dim);border-color:var(--green);color:var(--green);}

/* Doomsday */
.doom-input-bar{background:var(--bg-2);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px 20px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
.doom-label{font-family:var(--font-display);font-size:12px;font-weight:700;color:var(--red);text-transform:uppercase;letter-spacing:1px;}
.doom-unit{background:var(--bg-1);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden;}
.doom-unit-header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:var(--bg-2);border-bottom:1px solid var(--border);}
.doom-unit-title{font-family:var(--font-display);font-size:13px;font-weight:700;display:flex;align-items:center;gap:8px;}
.unit-num{width:22px;height:22px;background:var(--red-dim);color:var(--red);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;}
.doom-chart-area{padding:16px;}

/* IV */
.iv-strike-selector{display:flex;flex-wrap:wrap;gap:6px;padding:12px 20px;border-bottom:1px solid var(--border);background:var(--bg-2);}
.iv-strike-tag{display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:4px;border:1px solid var(--border);font-size:11px;color:var(--text-secondary);background:var(--bg-1);cursor:pointer;transition:var(--t);}
.iv-strike-tag.sel-call{background:var(--green-dim);border-color:var(--green);color:var(--green);}
.iv-strike-tag.sel-put{background:var(--red-dim);border-color:var(--red);color:var(--red);}
.iv-custom-input{display:flex;align-items:center;gap:8px;padding:8px 20px;border-top:1px solid var(--border);background:var(--bg-2);}
.iv-custom-label{font-size:11px;color:var(--text-dim);white-space:nowrap;}
.iv-strike-input{background:var(--bg-3);border:1px solid var(--border);border-radius:var(--radius);padding:4px 10px;font-family:var(--font-mono);font-size:12px;color:var(--text-primary);width:80px;outline:none;}
.iv-strike-input:focus{border-color:var(--purple);}
.iv-add-btn{background:var(--purple);color:#fff;border:none;border-radius:var(--radius);padding:4px 12px;font-size:11px;font-family:var(--font-display);font-weight:700;cursor:pointer;transition:var(--t);}
.iv-add-btn:hover{background:#b57bf5;}

/* Squeeze */
.squeeze-panel{margin:12px 16px;padding:12px 16px;background:var(--bg-2);border-radius:var(--radius);border:1px solid var(--border);}
.squeeze-title{font-family:var(--font-display);font-size:11px;font-weight:700;color:var(--text-dim);text-transform:uppercase;letter-spacing:.8px;margin-bottom:8px;}
.squeeze-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.squeeze-item{padding:8px 12px;border-radius:var(--radius);border:1px solid var(--border);background:var(--bg-1);}
.squeeze-direction{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;margin-bottom:4px;font-family:var(--font-display);}
.squeeze-direction.up{color:var(--green);}
.squeeze-direction.down{color:var(--red);}
.squeeze-detail{font-size:10px;color:var(--text-dim);margin-top:4px;line-height:1.5;}

/* Error toast */
.error-toast{position:fixed;bottom:24px;right:24px;background:#1a0a0a;border:1px solid var(--red);border-radius:var(--radius-lg);padding:14px 18px;color:var(--red);font-size:12px;max-width:400px;z-index:9999;animation:slideIn .3s ease;}
@keyframes slideIn{from{transform:translateX(100%);opacity:0;}to{transform:translateX(0);opacity:1;}}

::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
</style>
</head>
<body>

<header>
  <div class="logo"><div class="logo-dot"></div>GEX Monitor</div>
  <div class="header-right">
    <div class="market-status">
      <div class="status-dot" id="status-dot"></div>
      <span id="market-status-text">--</span>
    </div>
    <div id="global-time">--:--:-- ET</div>
  </div>
</header>

<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('gex',this)">GEX è§‚å¯Ÿ</button>
  <button class="tab-btn" onclick="switchTab('doomsday',this)">æœ«æ—¥è§‚å¯Ÿ</button>
</div>

<!-- â•â•â• GEX è§‚å¯Ÿ â•â•â• -->
<div class="tab-panel active" id="tab-gex">
  <div class="gex-section">

    <!-- æ ‡çš„1 -->
    <div class="symbol-row">
      <div class="symbol-input-bar">
        <div class="symbol-num">01</div>
        <input class="sym-input" id="gex-sym-1" placeholder="NVDA" maxlength="6" value="NVDA">
        <button class="load-btn" onclick="loadGEX(1)">åŠ è½½</button>
        <span style="font-size:10px;color:var(--text-dim)">æœŸè´§æœŸæƒè¯·ç”¨ETFæ›¿ä»£ï¼ˆ/ESâ†’SPY, /GCâ†’GLDï¼‰</span>
        <span class="update-time" id="gex-update-1">æœªåŠ è½½</span>
      </div>
      <div class="metrics-bar">
        <div class="metric-item"><div class="metric-label">ç°ä»· Spot</div><div class="metric-value" id="gex-spot-1">--</div></div>
        <div class="metric-item"><div class="metric-label">Gamma Flip</div><div class="metric-value yellow" id="gex-flip-1">--</div></div>
        <div class="metric-item"><div class="metric-label">Call Wall</div><div class="metric-value green" id="gex-callwall-1">--</div></div>
        <div class="metric-item"><div class="metric-label">Put Wall</div><div class="metric-value red" id="gex-putwall-1">--</div></div>
        <div class="metric-item"><div class="metric-label">ATM IV</div><div class="metric-value blue" id="gex-atmiv-1">--</div></div>
        <div class="metric-item"><div class="metric-label">Gamma ä½ç½®</div><div class="metric-value" id="gex-position-1">--</div></div>
      </div>
      <div class="expiry-section">
        <div class="expiry-toggle" onclick="toggleExpiry(1)">
          <div class="expiry-toggle-label">ğŸ“… åˆ°æœŸæ—¥ç­›é€‰ <span class="selected-summary" id="expiry-summary-1">--</span></div>
          <div style="display:flex;align-items:center;gap:8px">
            <button class="zoom-btn" onclick="event.stopPropagation();applyExpiry(1)">åº”ç”¨</button>
            <div class="chevron" id="expiry-chevron-1">â–¼</div>
          </div>
        </div>
        <div class="expiry-content" id="expiry-content-1">
          <div class="expiry-grid" id="expiry-grid-1"><span style="color:var(--text-dim);font-size:11px">è¯·å…ˆåŠ è½½æ•°æ®</span></div>
          <div class="expiry-actions">
            <button class="expiry-action-btn" onclick="selectAllExpiry(1,true)">å…¨é€‰</button>
            <button class="expiry-action-btn" onclick="selectAllExpiry(1,false)">æ¸…é™¤</button>
            <button class="expiry-action-btn" onclick="selectCurrentMonth(1)">æœ¬æœˆ</button>
          </div>
        </div>
      </div>
      <div class="chart-area">
        <div class="chart-controls">
          <span class="range-label">æ˜¾ç¤ºèŒƒå›´</span>
          <button class="zoom-btn active" id="zoom-1-20" onclick="setZoom(1,20)">Â±20</button>
          <button class="zoom-btn" id="zoom-1-40" onclick="setZoom(1,40)">Â±40</button>
          <button class="zoom-btn" id="zoom-1-0" onclick="setZoom(1,0)">å…¨éƒ¨</button>
        </div>
        <div class="chart-wrap" style="height:320px">
          <div class="chart-loading" id="loading-gex-1"><div class="spinner"></div><div class="loading-text">è¯·è¾“å…¥æ ‡çš„åç‚¹å‡»åŠ è½½</div></div>
          <canvas id="chart-gex-1"></canvas>
        </div>
      </div>
    </div>

    <!-- æ ‡çš„2 -->
    <div class="symbol-row">
      <div class="symbol-input-bar">
        <div class="symbol-num">02</div>
        <input class="sym-input" id="gex-sym-2" placeholder="SPY" maxlength="6" value="SPY">
        <button class="load-btn" onclick="loadGEX(2)">åŠ è½½</button>
        <span style="font-size:10px;color:var(--text-dim)">æœŸè´§æœŸæƒè¯·ç”¨ETFæ›¿ä»£ï¼ˆ/ESâ†’SPY, /GCâ†’GLDï¼‰</span>
        <span class="update-time" id="gex-update-2">æœªåŠ è½½</span>
      </div>
      <div class="metrics-bar">
        <div class="metric-item"><div class="metric-label">ç°ä»· Spot</div><div class="metric-value" id="gex-spot-2">--</div></div>
        <div class="metric-item"><div class="metric-label">Gamma Flip</div><div class="metric-value yellow" id="gex-flip-2">--</div></div>
        <div class="metric-item"><div class="metric-label">Call Wall</div><div class="metric-value green" id="gex-callwall-2">--</div></div>
        <div class="metric-item"><div class="metric-label">Put Wall</div><div class="metric-value red" id="gex-putwall-2">--</div></div>
        <div class="metric-item"><div class="metric-label">ATM IV</div><div class="metric-value blue" id="gex-atmiv-2">--</div></div>
        <div class="metric-item"><div class="metric-label">Gamma ä½ç½®</div><div class="metric-value" id="gex-position-2">--</div></div>
      </div>
      <div class="expiry-section">
        <div class="expiry-toggle" onclick="toggleExpiry(2)">
          <div class="expiry-toggle-label">ğŸ“… åˆ°æœŸæ—¥ç­›é€‰ <span class="selected-summary" id="expiry-summary-2">--</span></div>
          <div style="display:flex;align-items:center;gap:8px">
            <button class="zoom-btn" onclick="event.stopPropagation();applyExpiry(2)">åº”ç”¨</button>
            <div class="chevron" id="expiry-chevron-2">â–¼</div>
          </div>
        </div>
        <div class="expiry-content" id="expiry-content-2">
          <div class="expiry-grid" id="expiry-grid-2"><span style="color:var(--text-dim);font-size:11px">è¯·å…ˆåŠ è½½æ•°æ®</span></div>
          <div class="expiry-actions">
            <button class="expiry-action-btn" onclick="selectAllExpiry(2,true)">å…¨é€‰</button>
            <button class="expiry-action-btn" onclick="selectAllExpiry(2,false)">æ¸…é™¤</button>
            <button class="expiry-action-btn" onclick="selectCurrentMonth(2)">æœ¬æœˆ</button>
          </div>
        </div>
      </div>
      <div class="chart-area">
        <div class="chart-controls">
          <span class="range-label">æ˜¾ç¤ºèŒƒå›´</span>
          <button class="zoom-btn active" id="zoom-2-20" onclick="setZoom(2,20)">Â±20</button>
          <button class="zoom-btn" id="zoom-2-40" onclick="setZoom(2,40)">Â±40</button>
          <button class="zoom-btn" id="zoom-2-0" onclick="setZoom(2,0)">å…¨éƒ¨</button>
        </div>
        <div class="chart-wrap" style="height:320px">
          <div class="chart-loading" id="loading-gex-2"><div class="spinner"></div><div class="loading-text">è¯·è¾“å…¥æ ‡çš„åç‚¹å‡»åŠ è½½</div></div>
          <canvas id="chart-gex-2"></canvas>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- â•â•â• æœ«æ—¥è§‚å¯Ÿ â•â•â• -->
<div class="tab-panel" id="tab-doomsday">
  <div class="doomsday-section">

    <div class="doom-input-bar">
      <div class="doom-label">âš¡ æœ«æ—¥</div>
      <input class="sym-input" id="doom-sym" placeholder="SPY" maxlength="6" value="SPY">
      <button class="load-btn" style="background:var(--red);color:#fff" onclick="loadDoomsday()">åŠ è½½æœ«æ—¥æ•°æ®</button>
      <span class="update-time" id="doom-update">æœªåŠ è½½</span>
      <div style="display:flex;gap:0;margin-left:auto;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;">
        <div class="metric-item" style="border-right:1px solid var(--border)"><div class="metric-label">åˆ°æœŸæ—¥</div><div class="metric-value yellow" id="doom-exp-date">--</div></div>
        <div class="metric-item" style="border-right:1px solid var(--border)"><div class="metric-label">ç°ä»·</div><div class="metric-value" id="doom-spot">--</div></div>
        <div class="metric-item" style="border-right:1px solid var(--border)"><div class="metric-label">Call Wall</div><div class="metric-value green" id="doom-callwall">--</div></div>
        <div class="metric-item" style="border-right:1px solid var(--border)"><div class="metric-label">Put Wall</div><div class="metric-value red" id="doom-putwall">--</div></div>
        <div class="metric-item" style="border-right:1px solid var(--border)"><div class="metric-label">Flipç‚¹</div><div class="metric-value yellow" id="doom-flip">--</div></div>
        <div class="metric-item"><div class="metric-label">ATM IV</div><div class="metric-value blue" id="doom-atmiv">--</div></div>
      </div>
    </div>

    <!-- å•å…ƒâ‘  -->
    <div class="doom-unit">
      <div class="doom-unit-header">
        <div class="doom-unit-title"><div class="unit-num">1</div>0DTE GEX åˆ†å¸ƒ â€” æœ€è¿‘åˆ°æœŸæ—¥</div>
        <div style="display:flex;gap:8px">
          <button class="zoom-btn active" id="dzoom-20" onclick="setDoomZoom(20)">Â±20</button>
          <button class="zoom-btn" id="dzoom-40" onclick="setDoomZoom(40)">Â±40</button>
          <button class="zoom-btn" id="dzoom-0" onclick="setDoomZoom(0)">å…¨éƒ¨</button>
        </div>
      </div>
      <div class="doom-chart-area">
        <div class="chart-wrap" style="height:300px">
          <div class="chart-loading" id="loading-doom-1"><div class="spinner"></div><div class="loading-text">è¯·åŠ è½½æœ«æ—¥æ•°æ®</div></div>
          <canvas id="chart-doom-1"></canvas>
        </div>
      </div>
    </div>

    <!-- å•å…ƒâ‘¡ -->
    <div class="doom-unit">
      <div class="doom-unit-header">
        <div class="doom-unit-title"><div class="unit-num">2</div>æˆäº¤é‡ / æœªå¹³ä»“åˆçº¦ æ¯”ç‡ï¼ˆVol/OIï¼‰</div>
        <div style="font-size:11px;color:var(--text-dim)">ä¸ä¸Šæ–¹GEXå›¾è¡Œæƒä»·å¯¹é½ Â· é¢œè‰²è¶Šæ·±è¡¨ç¤ºæ´»è·ƒåº¦è¶Šé«˜</div>
      </div>
      <div class="doom-chart-area" style="padding:8px 16px 16px">
        <div class="chart-wrap" style="height:160px">
          <div class="chart-loading" id="loading-doom-2"><div class="spinner"></div><div class="loading-text">è¯·åŠ è½½æœ«æ—¥æ•°æ®</div></div>
          <canvas id="chart-doom-2"></canvas>
        </div>
      </div>
    </div>

    <!-- å•å…ƒâ‘¢ -->
    <div class="doom-unit">
      <div class="doom-unit-header">
        <div class="doom-unit-title"><div class="unit-num">3</div>å…³é”®è¡Œæƒä»· æ—¥å†… IV å˜åŒ–</div>
      </div>
      <div class="iv-strike-selector" id="iv-strike-tags">
        <span style="color:var(--text-dim);font-size:11px">åŠ è½½åæ˜¾ç¤ºCall/Putå¢™è¡Œæƒä»·</span>
      </div>
      <div class="iv-custom-input">
        <span class="iv-custom-label">è‡ªå®šä¹‰è¡Œæƒä»·ï¼š</span>
        <input class="iv-strike-input" id="iv-custom-strike" type="number" placeholder="190">
        <button class="iv-add-btn" onclick="addCustomIVStrike()">æ·»åŠ </button>
      </div>
      <div class="doom-chart-area">
        <div class="chart-wrap" style="height:240px">
          <div class="chart-loading" id="loading-doom-3"><div class="spinner"></div><div class="loading-text">è¯·åŠ è½½æœ«æ—¥æ•°æ®</div></div>
          <canvas id="chart-doom-3"></canvas>
        </div>
      </div>
      <div class="squeeze-panel">
        <div class="squeeze-title">âš¡ Gamma Squeeze åˆ¤æ–­ï¼ˆä¸‰æ¡ä»¶åŒæ—¶æ»¡è¶³ = é«˜é£é™©ï¼‰</div>
        <div class="squeeze-grid">
          <div class="squeeze-item">
            <div class="squeeze-direction up">â–² çœ‹æ¶¨æŒ¤å‹ï¼ˆçªç ´Call Wallï¼‰</div>
            <div style="font-size:13px;font-weight:600;margin:4px 0" id="squeeze-up-signal">ç­‰å¾…æ•°æ®...</div>
            <div class="squeeze-detail" id="squeeze-up-detail">æ¡ä»¶ï¼šâ‘ è·Call Wallâ‰¤1% â‘¡Call Wall IVæŒç»­ä¸Šå‡ â‘¢Vol/OI>0.3</div>
          </div>
          <div class="squeeze-item">
            <div class="squeeze-direction down">â–¼ çœ‹è·ŒæŒ¤å‹ï¼ˆè·Œç ´Put Wallï¼‰</div>
            <div style="font-size:13px;font-weight:600;margin:4px 0" id="squeeze-down-signal">ç­‰å¾…æ•°æ®...</div>
            <div class="squeeze-detail" id="squeeze-down-detail">æ¡ä»¶ï¼šâ‘ è·Put Wallâ‰¤1% â‘¡Put Wall IVæŒç»­ä¸Šå‡ â‘¢Vol/OI>0.3</div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
// â”€â”€â”€ é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const WORKER_URL = 'https://gex-monitor-worker.fibitrader.workers.dev';

// â”€â”€â”€ çŠ¶æ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const state = {
  gex: {
    1: { data:null, expirations:[], selectedDates:[], zoomRange:20, chart:null },
    2: { data:null, expirations:[], selectedDates:[], zoomRange:20, chart:null },
  },
  doom: {
    data:null, ivHistory:[], selectedStrikes:new Set(), customStrikes:new Set(),
    zoomRange:20, sharedLabels:[], charts:{c1:null,c2:null,c3:null}
  },
};

// â”€â”€â”€ Chart.js å…¨å±€é»˜è®¤ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Chart.defaults.color = '#8899aa';
Chart.defaults.borderColor = '#1e2d4240';
Chart.defaults.font.family = "'JetBrains Mono', monospace";
Chart.defaults.font.size = 11;

// â”€â”€â”€ Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab, btn) {
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  btn.classList.add('active');
}

// â”€â”€â”€ æ—¶é’Ÿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateClock() {
  const now = new Date();
  const etStr = now.toLocaleString('zh-CN',{timeZone:'America/New_York',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
  document.getElementById('global-time').textContent = etStr + ' ET';
  const et = new Date(now.toLocaleString('en-US',{timeZone:'America/New_York'}));
  const day = et.getDay(), mins = et.getHours()*60+et.getMinutes();
  const isOpen = day>=1&&day<=5&&mins>=8*60+30&&mins<16*60;
  const isPreMkt = day>=1&&day<=5&&mins>=8*60+30&&mins<9*60+30;
  const dot = document.getElementById('status-dot');
  const txt = document.getElementById('market-status-text');
  if(day===0||day===6){dot.className='status-dot closed';txt.textContent='å‘¨æœ«ä¼‘å¸‚';}
  else if(mins<8*60+30){dot.className='status-dot';txt.textContent='ç›˜å‰å‡†å¤‡ä¸­';}
  else if(isPreMkt){dot.className='status-dot active';txt.textContent='ç›‘æ§ä¸­ï¼ˆç›˜å‰ï¼‰';}
  else if(isOpen){dot.className='status-dot active';txt.textContent='ç›˜ä¸­';}
  else{dot.className='status-dot closed';txt.textContent='å·²æ”¶ç›˜';}
}
setInterval(updateClock,1000);
updateClock();

// â”€â”€â”€ API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function apiFetch(path) {
  const res = await fetch(WORKER_URL + path);
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
  return data;
}

// â”€â”€â”€ æ ¼å¼åŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmt2 = v => v!=null ? v.toFixed(2) : '--';
const fmtIV = v => v!=null&&v>0 ? v.toFixed(2)+'%' : '--';
function fmtGEX(v){const a=Math.abs(v);if(a>=1e9)return(v/1e9).toFixed(2)+'B';if(a>=1e6)return(v/1e6).toFixed(1)+'M';if(a>=1e3)return(v/1e3).toFixed(1)+'K';return v.toFixed(0);}

// â”€â”€â”€ æ˜¾ç¤ºé”™è¯¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showError(msg) {
  const el = document.createElement('div');
  el.className = 'error-toast';
  el.textContent = 'âŒ ' + msg;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(), 6000);
}

// â”€â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setLoading(id, on, msg='åŠ è½½ä¸­...') {
  const el = document.getElementById(id);
  if(!el)return;
  if(on){el.classList.remove('hidden');el.querySelector('.loading-text').textContent=msg;}
  else el.classList.add('hidden');
}

// â”€â”€â”€ æ‰¾æœ€è¿‘è¡Œæƒä»·ï¼ˆç”¨äºcategoryè½´annotationï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nearestStrikeLabel(labels, price) {
  if(!price||!labels.length)return null;
  return labels.reduce((prev,curr)=>Math.abs(Number(curr)-price)<Math.abs(Number(prev)-price)?curr:prev);
}

// â”€â”€â”€ æ„å»ºGEXå›¾è¡¨é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildGEXConfig(data, zoomRange) {
  const spot = data.spotPrice;
  let filtered = data.strikes;
  if(zoomRange>0&&spot) filtered = data.strikes.filter(s=>Math.abs(s.strike-spot)<=zoomRange);

  const labels = filtered.map(s=>String(s.strike));
  const callGex = filtered.map(s=>s.callGex/1e6);
  const putGex  = filtered.map(s=>s.putGex/1e6);

  // èšåˆGEXæ›²çº¿ï¼ˆç”¨åŸå§‹strikesçš„aggregateGexåšæ˜ å°„ï¼‰
  const aggMap = {};
  data.strikes.forEach((s,i)=>{aggMap[s.strike]=data.aggregateGex[i]/1e9;});
  const aggValues = filtered.map(s=>aggMap[s.strike]??0);

  // æ‰¾æœ€è¿‘è¡Œæƒä»·label
  const spotLabel    = nearestStrikeLabel(labels, spot);
  const flipLabel    = nearestStrikeLabel(labels, data.gammaFlip);
  const callWallLabel= nearestStrikeLabel(labels, data.callWall);
  const putWallLabel = nearestStrikeLabel(labels, data.putWall);

  const annotations = {};

  if(flipLabel) annotations.flip = {
    type:'line', xMin:flipLabel, xMax:flipLabel,
    borderColor:'#ff4757', borderWidth:1.5, borderDash:[5,4],
    label:{display:true,content:`Flip ${fmt2(data.gammaFlip)}`,position:'start',
           color:'#ff4757',backgroundColor:'rgba(8,11,15,0.8)',font:{size:10}}
  };

  if(spotLabel) annotations.spot = {
    type:'line', xMin:spotLabel, xMax:spotLabel,
    borderColor:'#00d084', borderWidth:2,
    label:{display:true,content:fmt2(spot),position:'start',
           color:'#00d084',backgroundColor:'rgba(8,11,15,0.8)',font:{size:10,weight:'bold'}}
  };

  if(callWallLabel&&callWallLabel!==spotLabel) annotations.callWall = {
    type:'line', xMin:callWallLabel, xMax:callWallLabel,
    borderColor:'#00d08470', borderWidth:1, borderDash:[4,3],
    label:{display:true,content:`CW ${data.callWall}`,position:'end',
           color:'#00d084',backgroundColor:'rgba(8,11,15,0.8)',font:{size:9}}
  };

  if(putWallLabel&&putWallLabel!==spotLabel) annotations.putWall = {
    type:'line', xMin:putWallLabel, xMax:putWallLabel,
    borderColor:'#ff475770', borderWidth:1, borderDash:[4,3],
    label:{display:true,content:`PW ${data.putWall}`,position:'end',
           color:'#ff4757',backgroundColor:'rgba(8,11,15,0.8)',font:{size:9}}
  };

  return {
    type:'bar',
    data:{
      labels,
      datasets:[
        {label:'Call GEX (M)',data:callGex,backgroundColor:'#00d08450',borderColor:'#00d084',borderWidth:1,yAxisID:'y'},
        {label:'Put GEX (M)',data:putGex,backgroundColor:'#ff475750',borderColor:'#ff4757',borderWidth:1,yAxisID:'y'},
        {label:'èšåˆ GEX (B)',data:aggValues,type:'line',yAxisID:'y2',borderColor:'#1e90ff',borderWidth:2,pointRadius:0,tension:0.4,fill:false},
      ]
    },
    options:{
      responsive:true,maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{labels:{boxWidth:12,padding:16}},
        annotation:{annotations},
        tooltip:{
          backgroundColor:'#131922',borderColor:'#1e2d42',borderWidth:1,
          callbacks:{label:ctx=>{
            const v=ctx.raw;
            if(ctx.datasetIndex===2)return `èšåˆGEX: ${v.toFixed(3)}B`;
            return `${ctx.dataset.label}: ${v.toFixed(1)}M`;
          }}
        }
      },
      scales:{
        x:{type:'category',grid:{color:'#1e2d4220'},ticks:{maxRotation:45,autoSkip:true,maxTicksLimit:24}},
        y:{position:'left',grid:{color:'#1e2d4220'},title:{display:true,text:'GEX (M)',color:'#4a5a6a'}},
        y2:{position:'right',grid:{display:false},title:{display:true,text:'èšåˆ GEX (B)',color:'#1e90ff50'},ticks:{color:'#1e90ff80'}}
      }
    }
  };
}

// â”€â”€â”€ GEX åŠ è½½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadGEX(idx) {
  const sym = document.getElementById(`gex-sym-${idx}`).value.trim().toUpperCase();
  if(!sym)return showError('è¯·è¾“å…¥æ ‡çš„ä»£ç ');
  setLoading(`loading-gex-${idx}`,true,'è·å–åˆ°æœŸæ—¥åˆ—è¡¨...');
  try {
    const expData = await apiFetch(`/api/expirations?symbol=${sym}`);
    state.gex[idx].expirations = expData.dates;
    const now = new Date();
    const m0 = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    const m1 = `${now.getFullYear()}-${String(now.getMonth()+2).padStart(2,'0')}`;
    state.gex[idx].selectedDates = expData.dates.filter(d=>d.startsWith(m0)||d.startsWith(m1));
    renderExpiryChips(idx, expData.dates, state.gex[idx].selectedDates);
    await fetchAndRenderGEX(idx, sym);
  } catch(e) {
    setLoading(`loading-gex-${idx}`,false);
    showError(e.message);
  }
}

async function fetchAndRenderGEX(idx, sym) {
  if(!sym) sym = document.getElementById(`gex-sym-${idx}`).value.trim().toUpperCase();
  setLoading(`loading-gex-${idx}`,true,'è®¡ç®—GEX...');
  try {
    const sel = state.gex[idx].selectedDates;
    const datesParam = sel.length ? `&dates=${sel.join(',')}` : '';
    const data = await apiFetch(`/api/gex?symbol=${sym}${datesParam}`);
    state.gex[idx].data = data;

    // æ›´æ–°æŒ‡æ ‡
    document.getElementById(`gex-spot-${idx}`).textContent = fmt2(data.spotPrice);
    document.getElementById(`gex-flip-${idx}`).textContent = fmt2(data.gammaFlip);
    document.getElementById(`gex-callwall-${idx}`).textContent = fmt2(data.callWall);
    document.getElementById(`gex-putwall-${idx}`).textContent = fmt2(data.putWall);
    document.getElementById(`gex-atmiv-${idx}`).textContent = fmtIV(data.atmIV);
    document.getElementById(`gex-update-${idx}`).textContent = data.updatedAt;

    const posEl = document.getElementById(`gex-position-${idx}`);
    if(data.spotPrice&&data.gammaFlip){
      if(data.spotPrice>data.gammaFlip){posEl.textContent='æ­£Gamma â–²';posEl.className='metric-value green';}
      else{posEl.textContent='è´ŸGamma â–¼';posEl.className='metric-value red';}
    }

    renderGEXChart(idx, data);
  } catch(e) {
    showError(e.message);
  } finally {
    setLoading(`loading-gex-${idx}`,false);
  }
}

function renderGEXChart(idx, data) {
  const canvas = document.getElementById(`chart-gex-${idx}`);
  if(state.gex[idx].chart){state.gex[idx].chart.destroy();state.gex[idx].chart=null;}
  const cfg = buildGEXConfig(data, state.gex[idx].zoomRange);
  state.gex[idx].chart = new Chart(canvas, cfg);
}

// â”€â”€â”€ ç¼©æ”¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setZoom(idx, range) {
  state.gex[idx].zoomRange = range;
  [20,40,0].forEach(r=>{
    const id = `zoom-${idx}-${r===0?'0':r}`;
    const btn = document.getElementById(id);
    if(btn)btn.classList.toggle('active',r===range);
  });
  if(state.gex[idx].data) renderGEXChart(idx, state.gex[idx].data);
}

function setDoomZoom(range) {
  state.doom.zoomRange = range;
  [20,40,0].forEach(r=>{
    const btn = document.getElementById(`dzoom-${r===0?'0':r}`);
    if(btn)btn.classList.toggle('active',r===range);
  });
  if(state.doom.data) renderDoomCharts(state.doom.data);
}

// â”€â”€â”€ åˆ°æœŸæ—¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderExpiryChips(idx, allDates, selectedDates) {
  const grid = document.getElementById(`expiry-grid-${idx}`);
  grid.innerHTML='';
  allDates.forEach(date=>{
    const isSel = selectedDates.includes(date);
    const chip = document.createElement('label');
    chip.className = `expiry-chip${isSel?' selected':''}`;
    chip.innerHTML = `<input type="checkbox" value="${date}"${isSel?' checked':''}> ${date}`;
    chip.querySelector('input').addEventListener('change',e=>{
      if(e.target.checked){if(!state.gex[idx].selectedDates.includes(date))state.gex[idx].selectedDates.push(date);chip.classList.add('selected');}
      else{state.gex[idx].selectedDates=state.gex[idx].selectedDates.filter(d=>d!==date);chip.classList.remove('selected');}
      updateExpirySummary(idx);
    });
    grid.appendChild(chip);
  });
  updateExpirySummary(idx);
}
function updateExpirySummary(idx){
  const n=state.gex[idx].selectedDates.length;
  document.getElementById(`expiry-summary-${idx}`).textContent=n>0?`å·²é€‰ ${n} ä¸ª`:'æœªé€‰æ‹©';
}
function toggleExpiry(idx){
  document.getElementById(`expiry-content-${idx}`).classList.toggle('open');
  document.getElementById(`expiry-chevron-${idx}`).classList.toggle('open');
}
function selectAllExpiry(idx,sel){
  state.gex[idx].selectedDates=sel?[...state.gex[idx].expirations]:[];
  renderExpiryChips(idx,state.gex[idx].expirations,state.gex[idx].selectedDates);
}
function selectCurrentMonth(idx){
  const now=new Date();
  const m=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  state.gex[idx].selectedDates=state.gex[idx].expirations.filter(d=>d.startsWith(m));
  renderExpiryChips(idx,state.gex[idx].expirations,state.gex[idx].selectedDates);
}
async function applyExpiry(idx){
  const sym=document.getElementById(`gex-sym-${idx}`).value.trim().toUpperCase();
  if(!sym||!state.gex[idx].data)return;
  document.getElementById(`expiry-content-${idx}`).classList.remove('open');
  document.getElementById(`expiry-chevron-${idx}`).classList.remove('open');
  await fetchAndRenderGEX(idx,sym);
}

// â”€â”€â”€ æœ«æ—¥è§‚å¯Ÿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDoomsday() {
  const sym = document.getElementById('doom-sym').value.trim().toUpperCase();
  if(!sym)return showError('è¯·è¾“å…¥æ ‡çš„ä»£ç ');
  ['1','2','3'].forEach(n=>setLoading(`loading-doom-${n}`,true,'åŠ è½½ä¸­...'));
  try {
    const [doomData, ivData] = await Promise.all([
      apiFetch(`/api/doomsday?symbol=${sym}`),
      apiFetch(`/api/iv-history?symbol=${sym}&doom=1`),
    ]);
    state.doom.data = doomData;
    state.doom.ivHistory = ivData.history;

    document.getElementById('doom-exp-date').textContent = doomData.expirationDate||'--';
    document.getElementById('doom-spot').textContent = fmt2(doomData.spotPrice);
    document.getElementById('doom-callwall').textContent = fmt2(doomData.callWall);
    document.getElementById('doom-putwall').textContent = fmt2(doomData.putWall);
    document.getElementById('doom-flip').textContent = fmt2(doomData.gammaFlip);
    document.getElementById('doom-atmiv').textContent = fmtIV(doomData.atmIV);
    document.getElementById('doom-update').textContent = doomData.updatedAt;

    state.doom.selectedStrikes = new Set();
    if(doomData.callWall) state.doom.selectedStrikes.add(`call:${doomData.callWall}`);
    if(doomData.putWall)  state.doom.selectedStrikes.add(`put:${doomData.putWall}`);

    renderIVStrikeTags(doomData);
    renderDoomCharts(doomData);
    updateSqueezePanel(doomData, ivData.history);
  } catch(e) {
    showError(e.message);
  } finally {
    ['1','2','3'].forEach(n=>setLoading(`loading-doom-${n}`,false));
  }
}

// â”€â”€â”€ æœ«æ—¥å›¾è¡¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getFilteredStrikes(data) {
  const spot = data.spotPrice;
  const range = state.doom.zoomRange;
  if(range>0&&spot) return data.strikes.filter(s=>Math.abs(s.strike-spot)<=range);
  return data.strikes;
}

function renderDoomCharts(data) {
  const filtered = getFilteredStrikes(data);
  // å…±äº«labelsç¡®ä¿å•å…ƒâ‘ â‘¡Xè½´å®Œå…¨å¯¹é½
  state.doom.sharedLabels = filtered.map(s=>String(s.strike));
  renderDoom1(data, filtered);
  renderDoom2(data, filtered);
  renderDoom3(state.doom.ivHistory, data);
}

// å•å…ƒâ‘ 
function renderDoom1(data, filtered) {
  const canvas = document.getElementById('chart-doom-1');
  if(state.doom.charts.c1){state.doom.charts.c1.destroy();state.doom.charts.c1=null;}

  const labels = state.doom.sharedLabels;
  const callGex = filtered.map(s=>s.callGex/1e6);
  const putGex  = filtered.map(s=>s.putGex/1e6);
  const aggMap = {};
  data.strikes.forEach((s,i)=>{aggMap[s.strike]=data.aggregateGex[i]/1e9;});
  const aggValues = filtered.map(s=>aggMap[s.strike]??0);

  const spot = data.spotPrice;
  const spotLabel     = nearestStrikeLabel(labels, spot);
  const flipLabel     = nearestStrikeLabel(labels, data.gammaFlip);
  const callWallLabel = nearestStrikeLabel(labels, data.callWall);
  const putWallLabel  = nearestStrikeLabel(labels, data.putWall);

  const annotations = {};
  if(flipLabel) annotations.flip={type:'line',xMin:flipLabel,xMax:flipLabel,borderColor:'#ff4757',borderWidth:1.5,borderDash:[5,4],label:{display:true,content:`Flip ${fmt2(data.gammaFlip)}`,position:'start',color:'#ff4757',backgroundColor:'rgba(8,11,15,0.8)',font:{size:10}}};
  if(spotLabel) annotations.spot={type:'line',xMin:spotLabel,xMax:spotLabel,borderColor:'#00d084',borderWidth:2,label:{display:true,content:fmt2(spot),position:'start',color:'#00d084',backgroundColor:'rgba(8,11,15,0.8)',font:{size:10,weight:'bold'}}};
  if(callWallLabel) annotations.callWall={type:'line',xMin:callWallLabel,xMax:callWallLabel,borderColor:'#00d08470',borderWidth:1,borderDash:[4,3],label:{display:true,content:`CW ${data.callWall}`,position:'end',color:'#00d084',backgroundColor:'rgba(8,11,15,0.8)',font:{size:9}}};
  if(putWallLabel)  annotations.putWall ={type:'line',xMin:putWallLabel, xMax:putWallLabel, borderColor:'#ff475770',borderWidth:1,borderDash:[4,3],label:{display:true,content:`PW ${data.putWall}`, position:'end',color:'#ff4757',backgroundColor:'rgba(8,11,15,0.8)',font:{size:9}}};

  // MaxGEX æ°´å¹³è™šçº¿
  if(data.maxGex?.value!=null) annotations.maxGex={type:'line',yMin:data.maxGex.value/1e6,yMax:data.maxGex.value/1e6,borderColor:'#ffd32a',borderWidth:1,borderDash:[6,3],label:{display:true,content:`MaxGEX@${data.maxGex.strike}`,position:'end',color:'#ffd32a',backgroundColor:'rgba(8,11,15,0.8)',font:{size:9}}};
  if(data.minGex?.value!=null) annotations.minGex={type:'line',yMin:data.minGex.value/1e6,yMax:data.minGex.value/1e6,borderColor:'#a55eea',borderWidth:1,borderDash:[6,3],label:{display:true,content:`MinGEX@${data.minGex.strike}`,position:'end',color:'#a55eea',backgroundColor:'rgba(8,11,15,0.8)',font:{size:9}}};

  state.doom.charts.c1 = new Chart(canvas, {
    type:'bar',
    data:{labels,datasets:[
      {label:'Call GEX (M)',data:callGex,backgroundColor:'#00d08450',borderColor:'#00d084',borderWidth:1,yAxisID:'y'},
      {label:'Put GEX (M)', data:putGex, backgroundColor:'#ff475750',borderColor:'#ff4757',borderWidth:1,yAxisID:'y'},
      {label:'èšåˆ GEX (B)',data:aggValues,type:'line',yAxisID:'y2',borderColor:'#1e90ff',borderWidth:2,pointRadius:0,tension:0.4,fill:false},
    ]},
    options:{
      responsive:true,maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{legend:{labels:{boxWidth:12,padding:16}},annotation:{annotations}},
      scales:{
        x:{type:'category',grid:{color:'#1e2d4220'},ticks:{maxRotation:45,autoSkip:true,maxTicksLimit:24}},
        y:{position:'left',grid:{color:'#1e2d4220'},title:{display:true,text:'GEX (M)',color:'#4a5a6a'}},
        y2:{position:'right',grid:{display:false},title:{display:true,text:'èšåˆ GEX (B)',color:'#1e90ff50'},ticks:{color:'#1e90ff80'}}
      }
    }
  });
}

// å•å…ƒâ‘¡ï¼šVol/OI â€” ä¸å•å…ƒâ‘ å…±äº«labels
function renderDoom2(data, filtered) {
  const canvas = document.getElementById('chart-doom-2');
  if(state.doom.charts.c2){state.doom.charts.c2.destroy();state.doom.charts.c2=null;}

  const labels = state.doom.sharedLabels; // â† ä¸å•å…ƒâ‘ å®Œå…¨ç›¸åŒçš„labels

  const maxVOI = Math.max(...filtered.map(s=>Math.max(s.callVol/(s.callOI||1), s.putVol/(s.putOI||1))), 0.01);

  const callRatios = filtered.map(s=>s.callOI>0?Math.min(s.callVol/s.callOI,10):0);
  const putRatios  = filtered.map(s=>s.putOI>0?Math.min(s.putVol/s.putOI,10):0);

  const callColors = callRatios.map(r=>{const i=Math.min(r/maxVOI,1);return `rgba(0,208,132,${0.15+i*0.85})`;});
  const putColors  = putRatios.map(r=>{const i=Math.min(r/maxVOI,1);return `rgba(255,71,87,${0.15+i*0.85})`;});

  const spot = data.spotPrice;
  const spotLabel = nearestStrikeLabel(labels, spot);
  const annotations = {};
  if(spotLabel) annotations.spot={type:'line',xMin:spotLabel,xMax:spotLabel,borderColor:'#00d08480',borderWidth:1,borderDash:[3,3]};

  state.doom.charts.c2 = new Chart(canvas, {
    type:'bar',
    data:{labels,datasets:[
      {label:'Call Vol/OI',data:callRatios,backgroundColor:callColors,borderWidth:0},
      {label:'Put Vol/OI', data:putRatios.map(v=>-v),backgroundColor:putColors,borderWidth:0},
    ]},
    options:{
      responsive:true,maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{labels:{boxWidth:12,padding:16}},
        annotation:{annotations},
        tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: ${Math.abs(ctx.raw).toFixed(2)}`}}
      },
      scales:{
        x:{type:'category',grid:{color:'#1e2d4220'},ticks:{maxRotation:45,autoSkip:true,maxTicksLimit:24}},
        y:{grid:{color:'#1e2d4220'},title:{display:true,text:'Vol/OI',color:'#4a5a6a'},ticks:{callback:v=>Math.abs(v).toFixed(1)}}
      }
    }
  });
}

// å•å…ƒâ‘¢ï¼šæ—¥å†…IVæ›²çº¿
function renderDoom3(ivHistory, data) {
  const canvas = document.getElementById('chart-doom-3');
  if(state.doom.charts.c3){state.doom.charts.c3.destroy();state.doom.charts.c3=null;}

  // è¿‡æ»¤æ‰æ— æ•ˆIVè®°å½•
  const validHistory = (ivHistory||[]).filter(h=>h.atmIV!=null&&h.atmIV>0);

  if(validHistory.length < 1) {
    setLoading('loading-doom-3', false);
    // æ˜¾ç¤ºç©ºå›¾æç¤º
    state.doom.charts.c3 = new Chart(canvas, {
      type:'line',data:{labels:['--'],datasets:[{label:'ç­‰å¾…æ•°æ®ç§¯ç´¯ï¼ˆæ¯15åˆ†é’Ÿè®°å½•ä¸€æ¬¡ï¼‰',data:[null],borderColor:'#4a5a6a',borderWidth:1}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{boxWidth:12}}},scales:{x:{},y:{title:{display:true,text:'IV (%)'}}}}
    });
    return;
  }

  const labels = validHistory.map(h=>{
    const t=new Date(h.timestamp);
    return t.toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit',timeZone:'America/New_York'});
  });

  const datasets = [];

  // ATM IV
  datasets.push({
    label:'ATM IV',
    data:validHistory.map(h=>h.atmIV),
    borderColor:'#1e90ff',borderWidth:2,pointRadius:3,tension:0.3,fill:false,
  });

  // Call Wall IV
  if(data&&state.doom.selectedStrikes.has(`call:${data.callWall}`)) {
    const cwData = validHistory.map(h=>h.callWallIV);
    if(cwData.some(v=>v!=null&&v>0)) {
      datasets.push({
        label:`Call Wall ${data.callWall} IV`,
        data:cwData,borderColor:'#00d084',borderWidth:2,
        pointRadius:3,tension:0.3,fill:false,borderDash:[5,3],
      });
    }
  }

  // Put Wall IV
  if(data&&state.doom.selectedStrikes.has(`put:${data.putWall}`)) {
    const pwData = validHistory.map(h=>h.putWallIV);
    if(pwData.some(v=>v!=null&&v>0)) {
      datasets.push({
        label:`Put Wall ${data.putWall} IV`,
        data:pwData,borderColor:'#ff4757',borderWidth:2,
        pointRadius:3,tension:0.3,fill:false,borderDash:[5,3],
      });
    }
  }

  state.doom.charts.c3 = new Chart(canvas, {
    type:'line',
    data:{labels,datasets},
    options:{
      responsive:true,maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{labels:{boxWidth:12,padding:16}},
        tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: ${ctx.raw!=null?ctx.raw.toFixed(2):'--'}%`}}
      },
      scales:{
        x:{grid:{color:'#1e2d4220'}},
        y:{grid:{color:'#1e2d4220'},title:{display:true,text:'IV (%)',color:'#4a5a6a'},
           ticks:{callback:v=>v.toFixed(1)+'%'}}
      }
    }
  });
}

// â”€â”€â”€ IV æ ‡ç­¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderIVStrikeTags(data) {
  const container = document.getElementById('iv-strike-tags');
  container.innerHTML='';
  const addTag=(key,label,type)=>{
    const tag=document.createElement('div');
    tag.className=`iv-strike-tag${state.doom.selectedStrikes.has(key)?' sel-'+type:''}`;
    tag.textContent=label;
    tag.onclick=()=>{
      if(state.doom.selectedStrikes.has(key)){state.doom.selectedStrikes.delete(key);tag.className='iv-strike-tag';}
      else{state.doom.selectedStrikes.add(key);tag.className=`iv-strike-tag sel-${type}`;}
      renderDoom3(state.doom.ivHistory, data);
    };
    container.appendChild(tag);
  };
  if(data.callWall) addTag(`call:${data.callWall}`,`ğŸ“ˆ Call Wall ${data.callWall}`,'call');
  if(data.putWall)  addTag(`put:${data.putWall}`, `ğŸ“‰ Put Wall ${data.putWall}`, 'put');
  state.doom.customStrikes.forEach(s=>addTag(`custom:${s}`,`â˜… ${s}`,'call'));
}

function addCustomIVStrike() {
  const val = parseFloat(document.getElementById('iv-custom-strike').value);
  if(isNaN(val))return showError('è¯·è¾“å…¥æœ‰æ•ˆçš„è¡Œæƒä»·');
  state.doom.customStrikes.add(val);
  state.doom.selectedStrikes.add(`custom:${val}`);
  if(state.doom.data){renderIVStrikeTags(state.doom.data);renderDoom3(state.doom.ivHistory,state.doom.data);}
}

// â”€â”€â”€ Gamma Squeeze åˆ¤æ–­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateSqueezePanel(data, ivHistory) {
  const spot=data.spotPrice, callWall=data.callWall, putWall=data.putWall;
  const valid=(ivHistory||[]).filter(h=>h.atmIV!=null&&h.atmIV>0);

  // çœ‹æ¶¨æŒ¤å‹
  const upEl=document.getElementById('squeeze-up-signal');
  const upDet=document.getElementById('squeeze-up-detail');
  if(callWall&&spot){
    const dist=Math.abs((callWall-spot)/spot*100);
    const cws=data.strikes.find(s=>s.strike===callWall);
    const voi=cws?cws.volOIRatio:0;
    let ivUp=false;
    if(valid.length>=3){const r=valid.slice(-3).map(h=>h.callWallIV||0);ivUp=r[0]<r[1]&&r[1]<r[2]&&r[2]>0;}
    const score=[dist<=1,ivUp,voi>0.3].filter(Boolean).length;
    const colors={3:'var(--red)',2:'var(--yellow)',1:'var(--text-secondary)',0:'var(--green)'};
    const texts={3:'ğŸ”´ é«˜é£é™© â€” ä¸‰æ¡ä»¶æ»¡è¶³ï¼ŒGammaæŒ¤å‹é£é™©æé«˜',2:'ğŸŸ¡ ä¸­ç­‰ â€” ä¸¤æ¡ä»¶æ»¡è¶³ï¼Œä¿æŒè­¦æƒ•',1:'âšª ä½é£é™© â€” ä»…ä¸€æ¡ä»¶æ»¡è¶³',0:'ğŸŸ¢ æ— ä¿¡å·'};
    upEl.textContent=texts[score]; upEl.style.color=colors[score];
    upDet.innerHTML=`â‘  è·Call Wall ${callWall}ï¼š${dist.toFixed(2)}%ï¼ˆâ‰¤1%è§¦å‘ï¼‰${dist<=1?'âœ“':'âœ—'}<br>â‘¡ Call Wall IVè¿ç»­ä¸Šå‡ï¼š${ivUp?'æ˜¯ âœ“':'å¦ âœ—'}ï¼ˆéœ€â‰¥3æ¡å†å²æ•°æ®ï¼‰<br>â‘¢ Call Wall Vol/OIï¼š${voi.toFixed(2)}ï¼ˆ>0.3è§¦å‘ï¼‰${voi>0.3?'âœ“':'âœ—'}`;
  }

  // çœ‹è·ŒæŒ¤å‹
  const downEl=document.getElementById('squeeze-down-signal');
  const downDet=document.getElementById('squeeze-down-detail');
  if(putWall&&spot){
    const dist=Math.abs((spot-putWall)/spot*100);
    const pws=data.strikes.find(s=>s.strike===putWall);
    const voi=pws?pws.volOIRatio:0;
    let ivUp=false;
    if(valid.length>=3){const r=valid.slice(-3).map(h=>h.putWallIV||0);ivUp=r[0]<r[1]&&r[1]<r[2]&&r[2]>0;}
    const score=[dist<=1,ivUp,voi>0.3].filter(Boolean).length;
    const colors={3:'var(--red)',2:'var(--yellow)',1:'var(--text-secondary)',0:'var(--green)'};
    const texts={3:'ğŸ”´ é«˜é£é™© â€” ä¸‰æ¡ä»¶æ»¡è¶³ï¼Œä¸‹è¡ŒæŒ¤å‹é£é™©æé«˜',2:'ğŸŸ¡ ä¸­ç­‰ â€” ä¸¤æ¡ä»¶æ»¡è¶³ï¼Œä¿æŒè­¦æƒ•',1:'âšª ä½é£é™©',0:'ğŸŸ¢ æ— ä¿¡å·'};
    downEl.textContent=texts[score]; downEl.style.color=colors[score];
    downDet.innerHTML=`â‘  è·Put Wall ${putWall}ï¼š${dist.toFixed(2)}%ï¼ˆâ‰¤1%è§¦å‘ï¼‰${dist<=1?'âœ“':'âœ—'}<br>â‘¡ Put Wall IVè¿ç»­ä¸Šå‡ï¼š${ivUp?'æ˜¯ âœ“':'å¦ âœ—'}ï¼ˆéœ€â‰¥3æ¡å†å²æ•°æ®ï¼‰<br>â‘¢ Put Wall Vol/OIï¼š${voi.toFixed(2)}ï¼ˆ>0.3è§¦å‘ï¼‰${voi>0.3?'âœ“':'âœ—'}`;
  }
}

// â”€â”€â”€ è‡ªåŠ¨åˆ·æ–° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setInterval(async()=>{
  const et=new Date(new Date().toLocaleString('en-US',{timeZone:'America/New_York'}));
  const day=et.getDay(),mins=et.getHours()*60+et.getMinutes();
  if(!(day>=1&&day<=5&&mins>=8*60+30&&mins<16*60))return;
  for(const idx of [1,2]){
    const sym=document.getElementById(`gex-sym-${idx}`).value.trim().toUpperCase();
    if(sym&&state.gex[idx].data)fetchAndRenderGEX(idx,sym).catch(()=>{});
  }
  const ds=document.getElementById('doom-sym').value.trim().toUpperCase();
  if(ds&&state.doom.data)loadDoomsday().catch(()=>{});
}, 15*60*1000);

// å¿«æ·é”®
document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('gex-sym-1').addEventListener('keydown',e=>{if(e.key==='Enter')loadGEX(1);});
  document.getElementById('gex-sym-2').addEventListener('keydown',e=>{if(e.key==='Enter')loadGEX(2);});
  document.getElementById('doom-sym').addEventListener('keydown',e=>{if(e.key==='Enter')loadDoomsday();});
});
</script>
</body>
</html>
