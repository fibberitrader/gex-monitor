<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GEX Monitor â€” æœŸæƒGammaæš´éœ²ç›‘æ§</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CSS å˜é‡ & åŸºç¡€
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg-0: #080b0f;
  --bg-1: #0d1117;
  --bg-2: #131922;
  --bg-3: #1a2332;
  --border: #1e2d42;
  --border-bright: #2a3f5a;

  --green: #00d084;
  --green-dim: #00d08440;
  --green-glow: #00d08420;
  --red: #ff4757;
  --red-dim: #ff475740;
  --red-glow: #ff475720;
  --yellow: #ffd32a;
  --yellow-dim: #ffd32a40;
  --blue: #1e90ff;
  --blue-dim: #1e90ff30;
  --purple: #a55eea;
  --cyan: #00d2d3;

  --text-primary: #e8edf5;
  --text-secondary: #8899aa;
  --text-dim: #4a5a6a;

  --font-mono: 'JetBrains Mono', monospace;
  --font-display: 'Syne', sans-serif;

  --radius: 6px;
  --radius-lg: 12px;
  --transition: 0.2s ease;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html { scroll-behavior: smooth; }

body {
  background: var(--bg-0);
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-size: 13px;
  line-height: 1.5;
  min-height: 100vh;
  overflow-x: hidden;
}

/* å™ªç‚¹èƒŒæ™¯çº¹ç† */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  pointer-events: none;
  z-index: 0;
  opacity: 0.5;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Header
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: var(--bg-1);
  border-bottom: 1px solid var(--border);
  padding: 0 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 56px;
  backdrop-filter: blur(12px);
}

.logo {
  font-family: var(--font-display);
  font-size: 18px;
  font-weight: 800;
  letter-spacing: -0.5px;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 10px;
}

.logo-dot {
  width: 8px; height: 8px;
  background: var(--green);
  border-radius: 50%;
  box-shadow: 0 0 8px var(--green);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.6; transform: scale(0.85); }
}

.header-right {
  display: flex;
  align-items: center;
  gap: 16px;
}

.market-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  color: var(--text-secondary);
  font-family: var(--font-mono);
}

.status-dot {
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--text-dim);
}

.status-dot.active { background: var(--green); box-shadow: 0 0 6px var(--green); }
.status-dot.closed { background: var(--red); }

#global-time {
  font-size: 11px;
  color: var(--text-secondary);
  font-variant-numeric: tabular-nums;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Tab å¯¼èˆª
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tabs {
  display: flex;
  gap: 2px;
  padding: 12px 24px 0;
  border-bottom: 1px solid var(--border);
  background: var(--bg-1);
}

.tab-btn {
  background: none;
  border: none;
  padding: 10px 20px;
  font-family: var(--font-display);
  font-size: 13px;
  font-weight: 600;
  color: var(--text-dim);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  transition: var(--transition);
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

.tab-btn:hover { color: var(--text-secondary); }
.tab-btn.active { color: var(--green); border-bottom-color: var(--green); }

.tab-panel { display: none; padding: 24px; }
.tab-panel.active { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   å¡ç‰‡ç»„ä»¶
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card {
  background: var(--bg-1);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
  transition: border-color var(--transition);
}

.card:hover { border-color: var(--border-bright); }

.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 20px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-2);
  gap: 12px;
  flex-wrap: wrap;
}

.card-title {
  font-family: var(--font-display);
  font-size: 14px;
  font-weight: 700;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 8px;
  letter-spacing: 0.3px;
}

.badge {
  font-size: 10px;
  padding: 2px 8px;
  border-radius: 20px;
  font-weight: 500;
  font-family: var(--font-mono);
  letter-spacing: 0.5px;
}

.badge-green { background: var(--green-dim); color: var(--green); }
.badge-red { background: var(--red-dim); color: var(--red); }
.badge-yellow { background: var(--yellow-dim); color: var(--yellow); }
.badge-blue { background: var(--blue-dim); color: var(--blue); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ç¬¬ä¸€éƒ¨åˆ† GEX è§‚å¯Ÿå¸ƒå±€
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.gex-section {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.symbol-row {
  display: flex;
  flex-direction: column;
  gap: 0;
}

/* è¾“å…¥åŒºåŸŸ */
.symbol-input-bar {
  background: var(--bg-2);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg) var(--radius-lg) 0 0;
  padding: 14px 20px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.symbol-num {
  font-family: var(--font-display);
  font-size: 11px;
  font-weight: 800;
  color: var(--text-dim);
  width: 20px;
  text-align: center;
  letter-spacing: 1px;
  text-transform: uppercase;
}

.sym-input {
  background: var(--bg-3);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 6px 12px;
  font-family: var(--font-mono);
  font-size: 14px;
  font-weight: 700;
  color: var(--text-primary);
  width: 100px;
  text-transform: uppercase;
  letter-spacing: 1px;
  transition: var(--transition);
  outline: none;
}

.sym-input:focus {
  border-color: var(--green);
  box-shadow: 0 0 0 2px var(--green-glow);
}

.load-btn {
  background: var(--green);
  color: #000;
  border: none;
  border-radius: var(--radius);
  padding: 6px 16px;
  font-family: var(--font-display);
  font-size: 12px;
  font-weight: 700;
  cursor: pointer;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  transition: var(--transition);
}

.load-btn:hover { background: #00f0a0; transform: translateY(-1px); }
.load-btn:active { transform: translateY(0); }

.load-btn:disabled {
  background: var(--bg-3);
  color: var(--text-dim);
  cursor: not-allowed;
  transform: none;
}

/* æŒ‡æ ‡æ  */
.metrics-bar {
  display: flex;
  gap: 0;
  border-left: 1px solid var(--border);
  border-right: 1px solid var(--border);
  overflow-x: auto;
  scrollbar-width: none;
}

.metric-item {
  flex: 1;
  min-width: 100px;
  padding: 10px 16px;
  border-right: 1px solid var(--border);
  border-bottom: 1px solid var(--border);
  background: var(--bg-1);
}

.metric-item:last-child { border-right: none; }

.metric-label {
  font-size: 10px;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-bottom: 4px;
}

.metric-value {
  font-size: 15px;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  color: var(--text-primary);
}

.metric-value.green { color: var(--green); }
.metric-value.red { color: var(--red); }
.metric-value.yellow { color: var(--yellow); }
.metric-value.blue { color: var(--blue); }

/* åˆ°æœŸæ—¥é€‰æ‹©å™¨ */
.expiry-section {
  border-left: 1px solid var(--border);
  border-right: 1px solid var(--border);
}

.expiry-toggle {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 20px;
  background: var(--bg-2);
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  user-select: none;
  transition: background var(--transition);
}

.expiry-toggle:hover { background: var(--bg-3); }

.expiry-toggle-label {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  display: flex;
  align-items: center;
  gap: 8px;
  font-family: var(--font-display);
}

.selected-summary {
  font-size: 11px;
  color: var(--green);
  font-family: var(--font-mono);
}

.chevron {
  font-size: 10px;
  color: var(--text-dim);
  transition: transform var(--transition);
}

.chevron.open { transform: rotate(180deg); }

.expiry-content {
  display: none;
  padding: 14px 20px;
  background: var(--bg-1);
  border-bottom: 1px solid var(--border);
}

.expiry-content.open { display: block; }

.expiry-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 10px;
}

.expiry-chip {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 4px 10px;
  border-radius: 4px;
  background: var(--bg-2);
  border: 1px solid var(--border);
  font-size: 11px;
  font-family: var(--font-mono);
  color: var(--text-secondary);
  cursor: pointer;
  transition: var(--transition);
  user-select: none;
}

.expiry-chip:hover { border-color: var(--border-bright); color: var(--text-primary); }

.expiry-chip.selected {
  background: var(--green-dim);
  border-color: var(--green);
  color: var(--green);
}

.expiry-chip input[type="checkbox"] {
  width: 12px; height: 12px;
  accent-color: var(--green);
}

.expiry-actions {
  display: flex;
  gap: 8px;
}

.expiry-action-btn {
  background: none;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 4px 10px;
  font-size: 11px;
  color: var(--text-secondary);
  cursor: pointer;
  font-family: var(--font-mono);
  transition: var(--transition);
}

.expiry-action-btn:hover {
  border-color: var(--green);
  color: var(--green);
}

/* å›¾è¡¨åŒºåŸŸ */
.chart-area {
  border: 1px solid var(--border);
  border-top: none;
  border-radius: 0 0 var(--radius-lg) var(--radius-lg);
  background: var(--bg-1);
  padding: 16px;
  position: relative;
}

.chart-wrap {
  position: relative;
  width: 100%;
}

.chart-loading {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: var(--bg-1);
  z-index: 10;
  gap: 12px;
}

.chart-loading.hidden { display: none; }

.spinner {
  width: 28px; height: 28px;
  border: 2px solid var(--border);
  border-top-color: var(--green);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.loading-text {
  font-size: 12px;
  color: var(--text-dim);
}

.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 300px;
  gap: 12px;
  color: var(--text-dim);
}

.empty-icon {
  font-size: 32px;
  opacity: 0.4;
}

.empty-text {
  font-size: 13px;
  text-align: center;
}

/* å›¾è¡¨ç¼©æ”¾æ§åˆ¶ */
.chart-controls {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  gap: 8px;
  margin-bottom: 10px;
  flex-wrap: wrap;
}

.range-label {
  font-size: 11px;
  color: var(--text-dim);
}

.range-input {
  width: 80px;
  height: 4px;
  accent-color: var(--green);
  cursor: pointer;
}

.zoom-btn {
  background: var(--bg-2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 3px 10px;
  font-size: 11px;
  color: var(--text-secondary);
  cursor: pointer;
  font-family: var(--font-mono);
  transition: var(--transition);
}

.zoom-btn:hover { border-color: var(--green); color: var(--green); }
.zoom-btn.active { background: var(--green-dim); border-color: var(--green); color: var(--green); }

/* æ›´æ–°æ—¶é—´ */
.update-time {
  font-size: 10px;
  color: var(--text-dim);
  font-family: var(--font-mono);
  margin-left: auto;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ç¬¬äºŒéƒ¨åˆ† æœ«æ—¥è§‚å¯Ÿ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.doomsday-section {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.doom-input-bar {
  background: var(--bg-2);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 14px 20px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

.doom-label {
  font-family: var(--font-display);
  font-size: 12px;
  font-weight: 700;
  color: var(--red);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.doom-unit {
  background: var(--bg-1);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: hidden;
}

.doom-unit-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 20px;
  background: var(--bg-2);
  border-bottom: 1px solid var(--border);
}

.doom-unit-title {
  font-family: var(--font-display);
  font-size: 13px;
  font-weight: 700;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 8px;
}

.unit-num {
  width: 22px; height: 22px;
  background: var(--red-dim);
  color: var(--red);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 800;
}

.doom-chart-area {
  padding: 16px;
}

/* Vol/OI çƒ­åŠ›å›¾è¡Œ */
.voi-bar-row {
  display: flex;
  align-items: stretch;
  gap: 0;
  height: 40px;
  overflow-x: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--border) transparent;
}

.voi-cell {
  flex-shrink: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-end;
  position: relative;
  min-width: 50px;
  gap: 2px;
}

.voi-bar {
  width: 60%;
  border-radius: 2px 2px 0 0;
  transition: height 0.3s ease;
}

.voi-value {
  font-size: 9px;
  color: var(--text-dim);
  font-variant-numeric: tabular-nums;
}

/* å•å…ƒâ‘¢ IVæ›²çº¿ */
.iv-strike-selector {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  padding: 12px 20px;
  border-bottom: 1px solid var(--border);
  background: var(--bg-2);
}

.iv-strike-tag {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 4px 10px;
  border-radius: 4px;
  border: 1px solid var(--border);
  font-size: 11px;
  font-family: var(--font-mono);
  color: var(--text-secondary);
  background: var(--bg-1);
  cursor: pointer;
  transition: var(--transition);
}

.iv-strike-tag.selected-call { background: var(--green-dim); border-color: var(--green); color: var(--green); }
.iv-strike-tag.selected-put { background: var(--red-dim); border-color: var(--red); color: var(--red); }

/* Gamma Squeeze åˆ¤æ–­é¢æ¿ */
.squeeze-panel {
  margin: 12px 16px;
  padding: 12px 16px;
  background: var(--bg-2);
  border-radius: var(--radius);
  border: 1px solid var(--border);
}

.squeeze-title {
  font-family: var(--font-display);
  font-size: 11px;
  font-weight: 700;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-bottom: 8px;
}

.squeeze-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
}

.squeeze-item {
  padding: 8px 12px;
  border-radius: var(--radius);
  border: 1px solid var(--border);
  background: var(--bg-1);
}

.squeeze-direction {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-bottom: 4px;
  font-family: var(--font-display);
}

.squeeze-direction.up { color: var(--green); }
.squeeze-direction.down { color: var(--red); }

.squeeze-signal {
  font-size: 12px;
  color: var(--text-primary);
  font-weight: 600;
}

.squeeze-detail {
  font-size: 10px;
  color: var(--text-dim);
  margin-top: 2px;
  line-height: 1.4;
}

/* IV è‡ªå®šä¹‰è¾“å…¥ */
.iv-custom-input {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 20px;
  border-top: 1px solid var(--border);
  background: var(--bg-2);
}

.iv-custom-label {
  font-size: 11px;
  color: var(--text-dim);
  white-space: nowrap;
}

.iv-strike-input {
  background: var(--bg-3);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 4px 10px;
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-primary);
  width: 80px;
  outline: none;
}

.iv-strike-input:focus { border-color: var(--purple); }

.iv-add-btn {
  background: var(--purple);
  color: #fff;
  border: none;
  border-radius: var(--radius);
  padding: 4px 12px;
  font-size: 11px;
  font-family: var(--font-display);
  font-weight: 700;
  cursor: pointer;
  letter-spacing: 0.5px;
  transition: var(--transition);
}

.iv-add-btn:hover { background: #b57bf5; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   å“åº”å¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 768px) {
  .tab-panel { padding: 16px; }
  .squeeze-grid { grid-template-columns: 1fr; }
  .metrics-bar { flex-wrap: wrap; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   å·¥å…·æç¤º
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tooltip-container { position: relative; }

.tooltip-content {
  display: none;
  position: absolute;
  top: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--bg-3);
  border: 1px solid var(--border-bright);
  border-radius: var(--radius);
  padding: 8px 12px;
  font-size: 11px;
  color: var(--text-secondary);
  white-space: nowrap;
  z-index: 200;
  pointer-events: none;
}

.tooltip-container:hover .tooltip-content { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   åŠ¨ç”»
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.fade-in { animation: fadeIn 0.3s ease forwards; }

/* æ»šåŠ¨æ¡ç¾åŒ– */
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
::-webkit-scrollbar-thumb:hover { background: var(--border-bright); }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     Header
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header>
  <div class="logo">
    <div class="logo-dot"></div>
    GEX Monitor
  </div>
  <div class="header-right">
    <div class="market-status">
      <div class="status-dot" id="status-dot"></div>
      <span id="market-status-text">--</span>
    </div>
    <div id="global-time">--:--:-- ET</div>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     Tab å¯¼èˆª
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('gex')">GEX è§‚å¯Ÿ</button>
  <button class="tab-btn" onclick="switchTab('doomsday')">æœ«æ—¥è§‚å¯Ÿ</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ç¬¬ä¸€éƒ¨åˆ†ï¼šGEX è§‚å¯Ÿ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-panel active" id="tab-gex">
  <div class="gex-section">

    <!-- æ ‡çš„ 1 -->
    <div class="symbol-row" id="gex-row-1">
      <div class="symbol-input-bar">
        <div class="symbol-num">01</div>
        <input class="sym-input" id="gex-sym-1" placeholder="NVDA" maxlength="6" value="NVDA">
        <button class="load-btn" onclick="loadGEX(1)">åŠ è½½</button>
        <span class="update-time" id="gex-update-1">æœªåŠ è½½</span>
      </div>

      <!-- æŒ‡æ ‡æ  -->
      <div class="metrics-bar" id="gex-metrics-1">
        <div class="metric-item">
          <div class="metric-label">ç°ä»· Spot</div>
          <div class="metric-value" id="gex-spot-1">--</div>
        </div>
        <div class="metric-item">
          <div class="metric-label">Gamma Flip</div>
          <div class="metric-value yellow" id="gex-flip-1">--</div>
        </div>
        <div class="metric-item">
          <div class="metric-label">Call Wall</div>
          <div class="metric-value green" id="gex-callwall-1">--</div>
        </div>
        <div class="metric-item">
          <div class="metric-label">Put Wall</div>
          <div class="metric-value red" id="gex-putwall-1">--</div>
        </div>
        <div class="metric-item">
          <div class="metric-label">ATM IV</div>
          <div class="metric-value blue" id="gex-atmiv-1">--</div>
        </div>
        <div class="metric-item">
          <div class="metric-label">ä»·æ ¼ä½ç½®</div>
          <div class="metric-value" id="gex-position-1">--</div>
        </div>
      </div>

      <!-- åˆ°æœŸæ—¥é€‰æ‹© -->
      <div class="expiry-section" id="expiry-section-1">
        <div class="expiry-toggle" onclick="toggleExpiry(1)">
          <div class="expiry-toggle-label">
            ğŸ“… åˆ°æœŸæ—¥ç­›é€‰
            <span class="selected-summary" id="expiry-summary-1">--</span>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <button class="zoom-btn" onclick="event.stopPropagation();applyExpiry(1)">åº”ç”¨</button>
            <div class="chevron" id="expiry-chevron-1">â–¼</div>
          </div>
        </div>
        <div class="expiry-content" id="expiry-content-1">
          <div class="expiry-grid" id="expiry-grid-1">
            <span style="color:var(--text-dim);font-size:11px">è¯·å…ˆè¾“å…¥æ ‡çš„å¹¶ç‚¹å‡»åŠ è½½</span>
          </div>
          <div class="expiry-actions">
            <button class="expiry-action-btn" onclick="selectAllExpiry(1, true)">å…¨é€‰</button>
            <button class="expiry-action-btn" onclick="selectAllExpiry(1, false)">æ¸…é™¤</button>
            <button class="expiry-action-btn" onclick="selectCurrentMonth(1)">æœ¬æœˆ</button>
          </div>
        </div>
      </div>

      <!-- å›¾è¡¨ -->
      <div class="chart-area">
        <div class="chart-controls">
          <span class="range-label">æ˜¾ç¤ºèŒƒå›´</span>
          <button class="zoom-btn active" onclick="setZoom(1, 20)" id="zoom-1-20">Â±20</button>
          <button class="zoom-btn" onclick="setZoom(1, 40)" id="zoom-1-40">Â±40</button>
          <button class="zoom-btn" onclick="setZoom(1, 0)" id="zoom-1-all">å…¨éƒ¨</button>
        </div>
        <div class="chart-wrap" style="height:320px;">
          <div class="chart-loading" id="loading-gex-1">
            <div class="spinner"></div>
            <div class="loading-text">ç­‰å¾…åŠ è½½...</div>
          </div>
          <canvas id="chart-gex-1"></canvas>
        </div>
      </div>
    </div>

    <!-- æ ‡çš„ 2 -->
    <div class="symbol-row" id="gex-row-2">
      <div class="symbol-input-bar">
        <div class="symbol-num">02</div>
        <input class="sym-input" id="gex-sym-2" placeholder="SPY" maxlength="6" value="SPY">
        <button class="load-btn" onclick="loadGEX(2)">åŠ è½½</button>
        <span class="update-time" id="gex-update-2">æœªåŠ è½½</span>
      </div>

      <div class="metrics-bar" id="gex-metrics-2">
        <div class="metric-item">
          <div class="metric-label">ç°ä»· Spot</div>
          <div class="metric-value" id="gex-spot-2">--</div>
        </div>
        <div class="metric-item">
          <div class="metric-label">Gamma Flip</div>
          <div class="metric-value yellow" id="gex-flip-2">--</div>
        </div>
        <div class="metric-item">
          <div class="metric-label">Call Wall</div>
          <div class="metric-value green" id="gex-callwall-2">--</div>
        </div>
        <div class="metric-item">
          <div class="metric-label">Put Wall</div>
          <div class="metric-value red" id="gex-putwall-2">--</div>
        </div>
        <div class="metric-item">
          <div class="metric-label">ATM IV</div>
          <div class="metric-value blue" id="gex-atmiv-2">--</div>
        </div>
        <div class="metric-item">
          <div class="metric-label">ä»·æ ¼ä½ç½®</div>
          <div class="metric-value" id="gex-position-2">--</div>
        </div>
      </div>

      <div class="expiry-section" id="expiry-section-2">
        <div class="expiry-toggle" onclick="toggleExpiry(2)">
          <div class="expiry-toggle-label">
            ğŸ“… åˆ°æœŸæ—¥ç­›é€‰
            <span class="selected-summary" id="expiry-summary-2">--</span>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <button class="zoom-btn" onclick="event.stopPropagation();applyExpiry(2)">åº”ç”¨</button>
            <div class="chevron" id="expiry-chevron-2">â–¼</div>
          </div>
        </div>
        <div class="expiry-content" id="expiry-content-2">
          <div class="expiry-grid" id="expiry-grid-2">
            <span style="color:var(--text-dim);font-size:11px">è¯·å…ˆè¾“å…¥æ ‡çš„å¹¶ç‚¹å‡»åŠ è½½</span>
          </div>
          <div class="expiry-actions">
            <button class="expiry-action-btn" onclick="selectAllExpiry(2, true)">å…¨é€‰</button>
            <button class="expiry-action-btn" onclick="selectAllExpiry(2, false)">æ¸…é™¤</button>
            <button class="expiry-action-btn" onclick="selectCurrentMonth(2)">æœ¬æœˆ</button>
          </div>
        </div>
      </div>

      <div class="chart-area">
        <div class="chart-controls">
          <span class="range-label">æ˜¾ç¤ºèŒƒå›´</span>
          <button class="zoom-btn active" onclick="setZoom(2, 20)" id="zoom-2-20">Â±20</button>
          <button class="zoom-btn" onclick="setZoom(2, 40)" id="zoom-2-40">Â±40</button>
          <button class="zoom-btn" onclick="setZoom(2, 0)" id="zoom-2-all">å…¨éƒ¨</button>
        </div>
        <div class="chart-wrap" style="height:320px;">
          <div class="chart-loading" id="loading-gex-2">
            <div class="spinner"></div>
            <div class="loading-text">ç­‰å¾…åŠ è½½...</div>
          </div>
          <canvas id="chart-gex-2"></canvas>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ç¬¬äºŒéƒ¨åˆ†ï¼šæœ«æ—¥è§‚å¯Ÿ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tab-panel" id="tab-doomsday">
  <div class="doomsday-section">

    <!-- è¾“å…¥æ  -->
    <div class="doom-input-bar">
      <div class="doom-label">âš¡ æœ«æ—¥</div>
      <input class="sym-input" id="doom-sym" placeholder="SPY" maxlength="6" value="SPY">
      <button class="load-btn" style="background:var(--red);color:#fff;" onclick="loadDoomsday()">åŠ è½½æœ«æ—¥æ•°æ®</button>
      <span class="update-time" id="doom-update">æœªåŠ è½½</span>

      <!-- æœ«æ—¥æŒ‡æ ‡ -->
      <div style="display:flex;gap:0;margin-left:auto;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;">
        <div class="metric-item" style="border-right:1px solid var(--border);">
          <div class="metric-label">åˆ°æœŸæ—¥</div>
          <div class="metric-value yellow" id="doom-exp-date">--</div>
        </div>
        <div class="metric-item" style="border-right:1px solid var(--border);">
          <div class="metric-label">ç°ä»·</div>
          <div class="metric-value" id="doom-spot">--</div>
        </div>
        <div class="metric-item" style="border-right:1px solid var(--border);">
          <div class="metric-label">Call Wall</div>
          <div class="metric-value green" id="doom-callwall">--</div>
        </div>
        <div class="metric-item" style="border-right:1px solid var(--border);">
          <div class="metric-label">Put Wall</div>
          <div class="metric-value red" id="doom-putwall">--</div>
        </div>
        <div class="metric-item" style="border-right:1px solid var(--border);">
          <div class="metric-label">Flipç‚¹</div>
          <div class="metric-value yellow" id="doom-flip">--</div>
        </div>
        <div class="metric-item">
          <div class="metric-label">Max GEX</div>
          <div class="metric-value green" id="doom-maxgex">--</div>
        </div>
      </div>
    </div>

    <!-- å•å…ƒâ‘ ï¼š0DTE GEXåˆ†å¸ƒ -->
    <div class="doom-unit">
      <div class="doom-unit-header">
        <div class="doom-unit-title">
          <div class="unit-num">1</div>
          0DTE GEX åˆ†å¸ƒ â€” æœ€è¿‘åˆ°æœŸæ—¥
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="zoom-btn active" onclick="setDoomZoom(20)" id="dzoom-20">Â±20</button>
          <button class="zoom-btn" onclick="setDoomZoom(40)" id="dzoom-40">Â±40</button>
          <button class="zoom-btn" onclick="setDoomZoom(0)" id="dzoom-all">å…¨éƒ¨</button>
        </div>
      </div>
      <div class="doom-chart-area">
        <div class="chart-wrap" style="height:300px;">
          <div class="chart-loading" id="loading-doom-1">
            <div class="spinner"></div>
            <div class="loading-text">ç­‰å¾…åŠ è½½...</div>
          </div>
          <canvas id="chart-doom-1"></canvas>
        </div>
      </div>
    </div>

    <!-- å•å…ƒâ‘¡ï¼šVol/OI æ¯”ç‡ -->
    <div class="doom-unit">
      <div class="doom-unit-header">
        <div class="doom-unit-title">
          <div class="unit-num">2</div>
          æˆäº¤é‡ / æœªå¹³ä»“åˆçº¦ æ¯”ç‡ï¼ˆVol/OIï¼‰
        </div>
        <div style="font-size:11px;color:var(--text-dim)">çƒ­åº¦è¶Šé«˜ â†’ å¸‚åœºå…³æ³¨åº¦è¶Šå¼º</div>
      </div>
      <div class="doom-chart-area">
        <div class="chart-wrap" style="height:180px;">
          <div class="chart-loading" id="loading-doom-2">
            <div class="spinner"></div>
            <div class="loading-text">ç­‰å¾…åŠ è½½...</div>
          </div>
          <canvas id="chart-doom-2"></canvas>
        </div>
      </div>
    </div>

    <!-- å•å…ƒâ‘¢ï¼šæ—¥å†…IVæ›²çº¿ -->
    <div class="doom-unit">
      <div class="doom-unit-header">
        <div class="doom-unit-title">
          <div class="unit-num">3</div>
          å…³é”®è¡Œæƒä»· æ—¥å†… IV å˜åŒ–
        </div>
      </div>

      <!-- è¡Œæƒä»·é€‰æ‹©æ ‡ç­¾ -->
      <div class="iv-strike-selector" id="iv-strike-tags">
        <span style="color:var(--text-dim);font-size:11px">åŠ è½½æ•°æ®åæ˜¾ç¤ºCall/Putå¢™è¡Œæƒä»·</span>
      </div>

      <!-- è‡ªå®šä¹‰è¡Œæƒä»·è¾“å…¥ -->
      <div class="iv-custom-input">
        <span class="iv-custom-label">è‡ªå®šä¹‰è¡Œæƒä»·ï¼š</span>
        <input class="iv-strike-input" id="iv-custom-strike" type="number" placeholder="190">
        <button class="iv-add-btn" onclick="addCustomIVStrike()">æ·»åŠ </button>
      </div>

      <div class="doom-chart-area">
        <div class="chart-wrap" style="height:240px;">
          <div class="chart-loading" id="loading-doom-3">
            <div class="spinner"></div>
            <div class="loading-text">ç­‰å¾…åŠ è½½...</div>
          </div>
          <canvas id="chart-doom-3"></canvas>
        </div>
      </div>

      <!-- Gamma Squeeze åˆ¤æ–­é¢æ¿ -->
      <div class="squeeze-panel">
        <div class="squeeze-title">âš¡ Gamma Squeeze åˆ¤æ–­é€»è¾‘</div>
        <div class="squeeze-grid">
          <div class="squeeze-item">
            <div class="squeeze-direction up">â–² ä¸Šæ–¹æŒ¤å‹ï¼ˆçœ‹æ¶¨ Gamma Squeezeï¼‰</div>
            <div class="squeeze-signal" id="squeeze-up-signal">ç­‰å¾…æ•°æ®...</div>
            <div class="squeeze-detail" id="squeeze-up-detail">
              æ¡ä»¶ï¼šâ‘  ä»·æ ¼è·Call Wall â‰¤ 1% â‘¡ Call Wall IVæŒç»­ä¸Šå‡ â‘¢ Call Wall Vol/OI > 0.3
            </div>
          </div>
          <div class="squeeze-item">
            <div class="squeeze-direction down">â–¼ ä¸‹æ–¹æŒ¤å‹ï¼ˆçœ‹è·Œ Gamma Squeezeï¼‰</div>
            <div class="squeeze-signal" id="squeeze-down-signal">ç­‰å¾…æ•°æ®...</div>
            <div class="squeeze-detail" id="squeeze-down-detail">
              æ¡ä»¶ï¼šâ‘  ä»·æ ¼è·Put Wall â‰¤ 1% â‘¡ Put Wall IVæŒç»­ä¸Šå‡ â‘¢ Put Wall Vol/OI > 0.3
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JavaScript
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â”€â”€â”€ é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// éƒ¨ç½²åæ›¿æ¢ä¸ºä½ çš„ Worker URL
const WORKER_URL = 'https://gex-monitor-worker.YOUR_SUBDOMAIN.workers.dev';

// â”€â”€â”€ çŠ¶æ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const state = {
  gex: {
    1: { data: null, expirations: [], selectedDates: [], zoomRange: 20, chart: null },
    2: { data: null, expirations: [], selectedDates: [], zoomRange: 20, chart: null },
  },
  doom: {
    data: null,
    ivHistory: [],
    selectedStrikes: new Set(),
    customStrikes: new Set(),
    zoomRange: 20,
    charts: { c1: null, c2: null, c3: null },
  },
};

let refreshTimer = null;

// â”€â”€â”€ Tab åˆ‡æ¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.getElementById(`tab-${tab}`).classList.add('active');
  event.currentTarget.classList.add('active');
}

// â”€â”€â”€ æ—¶é’Ÿ & å¸‚åœºçŠ¶æ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateClock() {
  const now = new Date();
  const etStr = now.toLocaleString('zh-CN', {
    timeZone: 'America/New_York',
    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
  });
  document.getElementById('global-time').textContent = etStr + ' ET';

  // åˆ¤æ–­å¸‚åœºæ—¶é—´
  const et = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
  const day = et.getDay();
  const h = et.getHours(), m = et.getMinutes();
  const mins = h * 60 + m;
  const isOpen = day >= 1 && day <= 5 && mins >= 8 * 60 + 30 && mins < 16 * 60;
  const isPreMarket = day >= 1 && day <= 5 && mins >= 8 * 60 + 30 && mins < 9 * 60 + 30;

  const dot = document.getElementById('status-dot');
  const txt = document.getElementById('market-status-text');
  if (day === 0 || day === 6) {
    dot.className = 'status-dot closed';
    txt.textContent = 'å‘¨æœ«ä¼‘å¸‚';
  } else if (mins < 8 * 60 + 30) {
    dot.className = 'status-dot';
    txt.textContent = 'ç›˜å‰';
  } else if (isPreMarket) {
    dot.className = 'status-dot active';
    txt.textContent = 'ç›‘æ§ä¸­ï¼ˆç›˜å‰ï¼‰';
  } else if (isOpen) {
    dot.className = 'status-dot active';
    txt.textContent = 'ç›˜ä¸­';
  } else {
    dot.className = 'status-dot closed';
    txt.textContent = 'å·²æ”¶ç›˜';
  }
}

setInterval(updateClock, 1000);
updateClock();

// â”€â”€â”€ API è°ƒç”¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function apiFetch(path) {
  const url = `${WORKER_URL}${path}`;
  const res = await fetch(url);
  if (!res.ok) {
    const err = await res.json().catch(() => ({ error: res.statusText }));
    throw new Error(err.error || `HTTP ${res.status}`);
  }
  return res.json();
}

// â”€â”€â”€ æ•°å­—æ ¼å¼åŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtGEX(v) {
  const abs = Math.abs(v);
  if (abs >= 1e9) return (v / 1e9).toFixed(2) + 'B';
  if (abs >= 1e6) return (v / 1e6).toFixed(1) + 'M';
  if (abs >= 1e3) return (v / 1e3).toFixed(1) + 'K';
  return v.toFixed(0);
}

function fmtPrice(v) {
  return v != null ? v.toFixed(2) : '--';
}

function fmtPct(v) {
  return v != null ? v.toFixed(2) + '%' : '--';
}

// â”€â”€â”€ å›¾è¡¨é€šç”¨é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Chart.defaults.color = '#8899aa';
Chart.defaults.borderColor = '#1e2d42';
Chart.defaults.font.family = "'JetBrains Mono', monospace";
Chart.defaults.font.size = 11;

function getGEXChartConfig(data, spotPrice, gammaFlip, callWall, putWall, zoomRange) {
  const st = data.strikes;
  let filtered = st;

  if (zoomRange > 0 && spotPrice) {
    filtered = st.filter(s => Math.abs(s.strike - spotPrice) <= zoomRange);
  }

  const labels = filtered.map(s => s.strike);
  const callGex = filtered.map(s => s.callGex / 1e6);
  const putGex = filtered.map(s => s.putGex / 1e6);

  // èšåˆGEXæ›²çº¿ï¼ˆå³è½´ï¼‰
  const aggMap = {};
  data.strikes.forEach((s, i) => { aggMap[s.strike] = data.aggregateGex[i] / 1e9; });
  const aggValues = filtered.map(s => aggMap[s.strike] || 0);

  const annotations = {};

  // Gamma Flip
  if (gammaFlip) {
    annotations.gammaFlip = {
      type: 'line', xMin: gammaFlip, xMax: gammaFlip,
      borderColor: '#ff4757', borderWidth: 1.5, borderDash: [4, 4],
      label: { display: true, content: `Flip ${fmtPrice(gammaFlip)}`, position: 'start',
               color: '#ff4757', backgroundColor: 'transparent', font: { size: 10 } }
    };
  }

  // Spot Price
  if (spotPrice) {
    annotations.spot = {
      type: 'line', xMin: spotPrice, xMax: spotPrice,
      borderColor: '#00d084', borderWidth: 2,
      label: { display: true, content: `${fmtPrice(spotPrice)}`, position: 'start',
               color: '#00d084', backgroundColor: 'transparent', font: { size: 10, weight: 'bold' } }
    };
  }

  // Call Wall
  if (callWall && (!zoomRange || Math.abs(callWall - spotPrice) <= zoomRange)) {
    annotations.callWall = {
      type: 'line', xMin: callWall, xMax: callWall,
      borderColor: '#00d08480', borderWidth: 1, borderDash: [3, 3],
      label: { display: true, content: `CW ${callWall}`, position: 'end',
               color: '#00d084', backgroundColor: 'transparent', font: { size: 9 } }
    };
  }

  // Put Wall
  if (putWall && (!zoomRange || Math.abs(putWall - spotPrice) <= zoomRange)) {
    annotations.putWall = {
      type: 'line', xMin: putWall, xMax: putWall,
      borderColor: '#ff475780', borderWidth: 1, borderDash: [3, 3],
      label: { display: true, content: `PW ${putWall}`, position: 'end',
               color: '#ff4757', backgroundColor: 'transparent', font: { size: 9 } }
    };
  }

  return {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'Call GEX (M)',
          data: callGex,
          backgroundColor: '#00d08460',
          borderColor: '#00d084',
          borderWidth: 1,
          yAxisID: 'y',
        },
        {
          label: 'Put GEX (M)',
          data: putGex,
          backgroundColor: '#ff475760',
          borderColor: '#ff4757',
          borderWidth: 1,
          yAxisID: 'y',
        },
        {
          label: 'èšåˆ GEX (B)',
          data: aggValues,
          type: 'line',
          yAxisID: 'y2',
          borderColor: '#1e90ff',
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.4,
          fill: false,
        },
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          labels: { boxWidth: 12, padding: 16, color: '#8899aa' }
        },
        annotation: { annotations },
        tooltip: {
          backgroundColor: '#131922',
          borderColor: '#1e2d42',
          borderWidth: 1,
          callbacks: {
            label: ctx => {
              const v = ctx.raw;
              if (ctx.datasetIndex === 2) return `èšåˆ GEX: ${v.toFixed(3)}B`;
              return `${ctx.dataset.label}: ${v.toFixed(1)}M`;
            }
          }
        }
      },
      scales: {
        x: {
          type: 'category',
          grid: { color: '#1e2d4240' },
          ticks: { maxRotation: 45, autoSkip: true, maxTicksLimit: 20 }
        },
        y: {
          position: 'left',
          grid: { color: '#1e2d4240' },
          title: { display: true, text: 'GEX (M)', color: '#4a5a6a' },
          stacked: false,
        },
        y2: {
          position: 'right',
          grid: { display: false },
          title: { display: true, text: 'èšåˆ GEX (B)', color: '#1e90ff60' },
          ticks: { color: '#1e90ff80' }
        }
      }
    }
  };
}

// â”€â”€â”€ GEX åŠ è½½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadGEX(idx) {
  const sym = document.getElementById(`gex-sym-${idx}`).value.trim().toUpperCase();
  if (!sym) return alert('è¯·è¾“å…¥æ ‡çš„ä»£ç ');

  setLoading(`loading-gex-${idx}`, true);

  try {
    // å…ˆè·å–åˆ°æœŸæ—¥åˆ—è¡¨
    const expData = await apiFetch(`/api/expirations?symbol=${sym}`);
    state.gex[idx].expirations = expData.dates;

    // é»˜è®¤é€‰å½“æœˆ+æ¬¡æœˆ
    const now = new Date();
    const thisMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    const nextMonth = `${now.getFullYear()}-${String(now.getMonth() + 2).padStart(2, '0')}`;
    state.gex[idx].selectedDates = expData.dates.filter(d => d.startsWith(thisMonth) || d.startsWith(nextMonth));

    // æ¸²æŸ“åˆ°æœŸæ—¥é€‰æ‹©å™¨
    renderExpiryChips(idx, expData.dates, state.gex[idx].selectedDates);

    // åŠ è½½GEXæ•°æ®
    await fetchAndRenderGEX(idx, sym);

  } catch (e) {
    setLoading(`loading-gex-${idx}`, false);
    alert(`åŠ è½½å¤±è´¥: ${e.message}`);
  }
}

async function fetchAndRenderGEX(idx, sym) {
  if (!sym) sym = document.getElementById(`gex-sym-${idx}`).value.trim().toUpperCase();
  setLoading(`loading-gex-${idx}`, true);

  try {
    const selectedDates = state.gex[idx].selectedDates;
    const datesParam = selectedDates.length ? `&dates=${selectedDates.join(',')}` : '';
    const data = await apiFetch(`/api/gex?symbol=${sym}${datesParam}`);
    state.gex[idx].data = data;

    // æ›´æ–°æŒ‡æ ‡
    document.getElementById(`gex-spot-${idx}`).textContent = fmtPrice(data.spotPrice);
    document.getElementById(`gex-flip-${idx}`).textContent = fmtPrice(data.gammaFlip);
    document.getElementById(`gex-callwall-${idx}`).textContent = fmtPrice(data.callWall);
    document.getElementById(`gex-putwall-${idx}`).textContent = fmtPrice(data.putWall);
    document.getElementById(`gex-atmiv-${idx}`).textContent = fmtPct(data.atmIV);
    document.getElementById(`gex-update-${idx}`).textContent = data.updatedAt;

    // ä»·æ ¼ä½ç½®
    const posEl = document.getElementById(`gex-position-${idx}`);
    if (data.spotPrice && data.gammaFlip) {
      if (data.spotPrice > data.gammaFlip) {
        posEl.textContent = 'æ­£Gamma â–²';
        posEl.className = 'metric-value green';
      } else {
        posEl.textContent = 'è´ŸGamma â–¼';
        posEl.className = 'metric-value red';
      }
    }

    // æ¸²æŸ“å›¾è¡¨
    renderGEXChart(idx, data);
    document.getElementById(`gex-update-${idx}`).textContent = data.updatedAt;

  } catch (e) {
    alert(`æ•°æ®è·å–å¤±è´¥: ${e.message}`);
  } finally {
    setLoading(`loading-gex-${idx}`, false);
  }
}

function renderGEXChart(idx, data) {
  const canvas = document.getElementById(`chart-gex-${idx}`);
  if (state.gex[idx].chart) {
    state.gex[idx].chart.destroy();
  }

  const zoomRange = state.gex[idx].zoomRange;
  const cfg = getGEXChartConfig(data, data.spotPrice, data.gammaFlip, data.callWall, data.putWall, zoomRange);
  state.gex[idx].chart = new Chart(canvas, cfg);
}

// â”€â”€â”€ ç¼©æ”¾æ§åˆ¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setZoom(idx, range) {
  state.gex[idx].zoomRange = range;
  // æ›´æ–°æŒ‰é’®çŠ¶æ€
  [20, 40, 0].forEach(r => {
    const suffix = r === 0 ? 'all' : r;
    const btn = document.getElementById(`zoom-${idx}-${suffix}`);
    if (btn) btn.classList.toggle('active', r === range);
  });

  if (state.gex[idx].data) {
    renderGEXChart(idx, state.gex[idx].data);
  }
}

function setDoomZoom(range) {
  state.doom.zoomRange = range;
  [20, 40, 0].forEach(r => {
    const suffix = r === 0 ? 'all' : r;
    const btn = document.getElementById(`dzoom-${suffix}`);
    if (btn) btn.classList.toggle('active', r === range);
  });
  if (state.doom.data) renderDoomCharts(state.doom.data);
}

// â”€â”€â”€ åˆ°æœŸæ—¥é€‰æ‹©å™¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderExpiryChips(idx, allDates, selectedDates) {
  const grid = document.getElementById(`expiry-grid-${idx}`);
  grid.innerHTML = '';

  allDates.forEach(date => {
    const isSelected = selectedDates.includes(date);
    const chip = document.createElement('label');
    chip.className = `expiry-chip ${isSelected ? 'selected' : ''}`;

    // åˆ¤æ–­æ˜¯å¦æ˜¯å‘¨åˆ°æœŸ/æœˆåˆ°æœŸ
    const d = new Date(date + 'T00:00:00');
    const dayOfWeek = d.getDay();
    const isMonthly = dayOfWeek === 5 && (d.getDate() >= 15 && d.getDate() <= 21); // ç¬¬3ä¸ªå‘¨äº”
    const label = isMonthly ? `ğŸ“Œ ${date}` : date;

    chip.innerHTML = `<input type="checkbox" value="${date}" ${isSelected ? 'checked' : ''}> ${label}`;
    chip.querySelector('input').addEventListener('change', (e) => {
      if (e.target.checked) {
        if (!state.gex[idx].selectedDates.includes(date)) state.gex[idx].selectedDates.push(date);
        chip.classList.add('selected');
      } else {
        state.gex[idx].selectedDates = state.gex[idx].selectedDates.filter(d => d !== date);
        chip.classList.remove('selected');
      }
      updateExpirySummary(idx);
    });

    grid.appendChild(chip);
  });

  updateExpirySummary(idx);
}

function updateExpirySummary(idx) {
  const n = state.gex[idx].selectedDates.length;
  document.getElementById(`expiry-summary-${idx}`).textContent = n > 0 ? `å·²é€‰ ${n} ä¸ª` : 'æœªé€‰æ‹©';
}

function toggleExpiry(idx) {
  const content = document.getElementById(`expiry-content-${idx}`);
  const chevron = document.getElementById(`expiry-chevron-${idx}`);
  content.classList.toggle('open');
  chevron.classList.toggle('open');
}

function selectAllExpiry(idx, select) {
  state.gex[idx].selectedDates = select ? [...state.gex[idx].expirations] : [];
  renderExpiryChips(idx, state.gex[idx].expirations, state.gex[idx].selectedDates);
}

function selectCurrentMonth(idx) {
  const now = new Date();
  const thisMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
  state.gex[idx].selectedDates = state.gex[idx].expirations.filter(d => d.startsWith(thisMonth));
  renderExpiryChips(idx, state.gex[idx].expirations, state.gex[idx].selectedDates);
}

async function applyExpiry(idx) {
  const sym = document.getElementById(`gex-sym-${idx}`).value.trim().toUpperCase();
  if (!sym || !state.gex[idx].data) return;
  // æŠ˜å é€‰æ‹©å™¨
  document.getElementById(`expiry-content-${idx}`).classList.remove('open');
  document.getElementById(`expiry-chevron-${idx}`).classList.remove('open');
  await fetchAndRenderGEX(idx, sym);
}

// â”€â”€â”€ æœ«æ—¥è§‚å¯Ÿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDoomsday() {
  const sym = document.getElementById('doom-sym').value.trim().toUpperCase();
  if (!sym) return alert('è¯·è¾“å…¥æ ‡çš„ä»£ç ');

  setLoading('loading-doom-1', true);
  setLoading('loading-doom-2', true);
  setLoading('loading-doom-3', true);

  try {
    const [doomData, ivHistory] = await Promise.all([
      apiFetch(`/api/doomsday?symbol=${sym}`),
      apiFetch(`/api/iv-history?symbol=${sym}`),
    ]);

    state.doom.data = doomData;
    state.doom.ivHistory = ivHistory.history;

    // æ›´æ–°æŒ‡æ ‡
    document.getElementById('doom-exp-date').textContent = doomData.expirationDate || '--';
    document.getElementById('doom-spot').textContent = fmtPrice(doomData.spotPrice);
    document.getElementById('doom-callwall').textContent = fmtPrice(doomData.callWall);
    document.getElementById('doom-putwall').textContent = fmtPrice(doomData.putWall);
    document.getElementById('doom-flip').textContent = fmtPrice(doomData.gammaFlip);
    document.getElementById('doom-maxgex').textContent = doomData.maxGex ? fmtPrice(doomData.maxGex.strike) : '--';
    document.getElementById('doom-update').textContent = doomData.updatedAt;

    // é»˜è®¤é€‰ä¸­ Call Wall å’Œ Put Wall
    state.doom.selectedStrikes = new Set();
    if (doomData.callWall) state.doom.selectedStrikes.add(`call:${doomData.callWall}`);
    if (doomData.putWall) state.doom.selectedStrikes.add(`put:${doomData.putWall}`);

    renderIVStrikeTags(doomData);
    renderDoomCharts(doomData);
    updateSqueezePanel(doomData, ivHistory.history);

  } catch (e) {
    alert(`åŠ è½½å¤±è´¥: ${e.message}`);
  } finally {
    setLoading('loading-doom-1', false);
    setLoading('loading-doom-2', false);
    setLoading('loading-doom-3', false);
  }
}

function renderDoomCharts(data) {
  renderDoom1(data);
  renderDoom2(data);
  renderDoom3(state.doom.ivHistory, data);
}

// å•å…ƒâ‘ ï¼š0DTE GEXåˆ†å¸ƒ
function renderDoom1(data) {
  const canvas = document.getElementById('chart-doom-1');
  if (state.doom.charts.c1) state.doom.charts.c1.destroy();

  let filtered = data.strikes;
  if (state.doom.zoomRange > 0 && data.spotPrice) {
    filtered = data.strikes.filter(s => Math.abs(s.strike - data.spotPrice) <= state.doom.zoomRange);
  }

  const labels = filtered.map(s => s.strike);
  const callGex = filtered.map(s => s.callGex / 1e6);
  const putGex = filtered.map(s => s.putGex / 1e6);

  // èšåˆGEXæ›²çº¿
  const aggMap = {};
  data.strikes.forEach((s, i) => { aggMap[s.strike] = data.aggregateGex[i] / 1e9; });
  const aggValues = filtered.map(s => aggMap[s.strike] || 0);

  const annotations = {};

  if (data.gammaFlip) {
    annotations.flip = {
      type: 'line', xMin: data.gammaFlip, xMax: data.gammaFlip,
      borderColor: '#ff4757', borderWidth: 1.5, borderDash: [4, 4],
      label: { display: true, content: `Flip ${fmtPrice(data.gammaFlip)}`, position: 'start',
               color: '#ff4757', backgroundColor: 'transparent', font: { size: 10 } }
    };
  }

  if (data.spotPrice) {
    annotations.spot = {
      type: 'line', xMin: data.spotPrice, xMax: data.spotPrice,
      borderColor: '#00d084', borderWidth: 2,
      label: { display: true, content: fmtPrice(data.spotPrice), position: 'start',
               color: '#00d084', backgroundColor: 'transparent', font: { size: 10, weight: 'bold' } }
    };
  }

  // Max GEX è™šçº¿
  if (data.maxGex?.strike) {
    annotations.maxGex = {
      type: 'line',
      yMin: data.maxGex.value / 1e6, yMax: data.maxGex.value / 1e6,
      borderColor: '#ffd32a', borderWidth: 1, borderDash: [5, 3],
      label: { display: true, content: `MaxGEX @ ${data.maxGex.strike}`, position: 'end',
               color: '#ffd32a', backgroundColor: 'transparent', font: { size: 9 } }
    };
  }

  // Min GEX è™šçº¿
  if (data.minGex?.strike) {
    annotations.minGex = {
      type: 'line',
      yMin: data.minGex.value / 1e6, yMax: data.minGex.value / 1e6,
      borderColor: '#a55eea', borderWidth: 1, borderDash: [5, 3],
      label: { display: true, content: `MinGEX @ ${data.minGex.strike}`, position: 'end',
               color: '#a55eea', backgroundColor: 'transparent', font: { size: 9 } }
    };
  }

  if (data.callWall) {
    annotations.callWall = {
      type: 'line', xMin: data.callWall, xMax: data.callWall,
      borderColor: '#00d08480', borderWidth: 1, borderDash: [3, 3],
      label: { display: true, content: `CW ${data.callWall}`, position: 'end',
               color: '#00d084', backgroundColor: 'transparent', font: { size: 9 } }
    };
  }

  if (data.putWall) {
    annotations.putWall = {
      type: 'line', xMin: data.putWall, xMax: data.putWall,
      borderColor: '#ff475780', borderWidth: 1, borderDash: [3, 3],
      label: { display: true, content: `PW ${data.putWall}`, position: 'end',
               color: '#ff4757', backgroundColor: 'transparent', font: { size: 9 } }
    };
  }

  state.doom.charts.c1 = new Chart(canvas, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Call GEX (M)', data: callGex, backgroundColor: '#00d08460', borderColor: '#00d084', borderWidth: 1, yAxisID: 'y' },
        { label: 'Put GEX (M)', data: putGex, backgroundColor: '#ff475760', borderColor: '#ff4757', borderWidth: 1, yAxisID: 'y' },
        { label: 'èšåˆ GEX (B)', data: aggValues, type: 'line', yAxisID: 'y2', borderColor: '#1e90ff', borderWidth: 2, pointRadius: 0, tension: 0.4, fill: false },
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: { legend: { labels: { boxWidth: 12, padding: 16 } }, annotation: { annotations } },
      scales: {
        x: { type: 'category', grid: { color: '#1e2d4240' }, ticks: { maxRotation: 45, autoSkip: true, maxTicksLimit: 20 } },
        y: { position: 'left', grid: { color: '#1e2d4240' }, title: { display: true, text: 'GEX (M)', color: '#4a5a6a' } },
        y2: { position: 'right', grid: { display: false }, title: { display: true, text: 'èšåˆ GEX (B)', color: '#1e90ff60' }, ticks: { color: '#1e90ff80' } },
      }
    }
  });
}

// å•å…ƒâ‘¡ï¼šVol/OI æ¯”ç‡å›¾
function renderDoom2(data) {
  const canvas = document.getElementById('chart-doom-2');
  if (state.doom.charts.c2) state.doom.charts.c2.destroy();

  let filtered = data.strikes;
  if (state.doom.zoomRange > 0 && data.spotPrice) {
    filtered = data.strikes.filter(s => Math.abs(s.strike - data.spotPrice) <= state.doom.zoomRange);
  }

  const labels = filtered.map(s => s.strike);
  const callRatios = filtered.map(s => s.callOI > 0 ? Math.min(s.callVol / s.callOI, 5) : 0);
  const putRatios = filtered.map(s => s.putOI > 0 ? Math.min(s.putVol / s.putOI, 5) : 0);

  // çƒ­åŠ›å›¾è‰²å½©ï¼šVol/OIè¶Šé«˜è¶Šäº®
  const maxRatio = Math.max(...callRatios, ...putRatios, 1);
  const callColors = callRatios.map(r => {
    const intensity = r / maxRatio;
    return `rgba(0, ${Math.floor(208 * intensity + 50), 0}, ${Math.floor(132 * intensity)}, ${0.3 + intensity * 0.7})`;
  });

  const annotations = {};
  if (data.spotPrice) {
    annotations.spot = {
      type: 'line', xMin: data.spotPrice, xMax: data.spotPrice,
      borderColor: '#00d08480', borderWidth: 1, borderDash: [3, 3],
    };
  }

  state.doom.charts.c2 = new Chart(canvas, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'Call Vol/OI',
          data: callRatios,
          backgroundColor: filtered.map(s => {
            const r = s.callOI > 0 ? s.callVol / s.callOI : 0;
            const i = Math.min(r / maxRatio, 1);
            return `rgba(0, 208, 132, ${0.2 + i * 0.8})`;
          }),
          borderWidth: 0,
        },
        {
          label: 'Put Vol/OI',
          data: putRatios.map(v => -v),
          backgroundColor: filtered.map(s => {
            const r = s.putOI > 0 ? s.putVol / s.putOI : 0;
            const i = Math.min(r / maxRatio, 1);
            return `rgba(255, 71, 87, ${0.2 + i * 0.8})`;
          }),
          borderWidth: 0,
        },
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { labels: { boxWidth: 12, padding: 16 } },
        annotation: { annotations },
        tooltip: {
          callbacks: {
            label: ctx => {
              const abs = Math.abs(ctx.raw);
              return `${ctx.dataset.label}: ${abs.toFixed(2)}`;
            }
          }
        }
      },
      scales: {
        x: { type: 'category', grid: { color: '#1e2d4240' }, ticks: { maxRotation: 45, autoSkip: true, maxTicksLimit: 20 } },
        y: {
          grid: { color: '#1e2d4240' },
          title: { display: true, text: 'Vol/OI', color: '#4a5a6a' },
          ticks: { callback: v => Math.abs(v).toFixed(1) }
        },
      }
    }
  });
}

// å•å…ƒâ‘¢ï¼šæ—¥å†…IVå˜åŒ–æ›²çº¿
function renderDoom3(ivHistory, data) {
  const canvas = document.getElementById('chart-doom-3');
  if (state.doom.charts.c3) state.doom.charts.c3.destroy();

  if (!ivHistory || ivHistory.length < 2) {
    setLoading('loading-doom-3', false);
    return;
  }

  const labels = ivHistory.map(h => {
    const t = new Date(h.timestamp);
    return t.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', timeZone: 'America/New_York' });
  });

  const datasets = [];

  // ATM IV
  datasets.push({
    label: `ATM IV`,
    data: ivHistory.map(h => h.atmIV),
    borderColor: '#1e90ff',
    borderWidth: 2,
    pointRadius: 2,
    tension: 0.3,
    fill: false,
  });

  // Call Wall IV
  if (state.doom.selectedStrikes.has(`call:${data?.callWall}`)) {
    datasets.push({
      label: `Call Wall ${data.callWall} IV`,
      data: ivHistory.map(h => h.callWallIV),
      borderColor: '#00d084',
      borderWidth: 2,
      pointRadius: 2,
      tension: 0.3,
      fill: false,
      borderDash: [4, 2],
    });
  }

  // Put Wall IV
  if (state.doom.selectedStrikes.has(`put:${data?.putWall}`)) {
    datasets.push({
      label: `Put Wall ${data.putWall} IV`,
      data: ivHistory.map(h => h.putWallIV),
      borderColor: '#ff4757',
      borderWidth: 2,
      pointRadius: 2,
      tension: 0.3,
      fill: false,
      borderDash: [4, 2],
    });
  }

  state.doom.charts.c3 = new Chart(canvas, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { labels: { boxWidth: 12, padding: 16 } },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.dataset.label}: ${ctx.raw?.toFixed(2) || '--'}%`
          }
        }
      },
      scales: {
        x: { grid: { color: '#1e2d4240' } },
        y: { grid: { color: '#1e2d4240' }, title: { display: true, text: 'IV (%)', color: '#4a5a6a' } },
      }
    }
  });
}

// â”€â”€â”€ Gamma Squeeze åˆ¤æ–­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
/**
 * Gamma Squeeze åˆ¤æ–­é€»è¾‘ï¼š
 *
 * çœ‹æ¶¨æŒ¤å‹ï¼ˆä¸Šæ–¹ï¼‰ï¼š
 *   â‘  ç°ä»·è·Call Wall â‰¤ 1%ï¼ˆæ¥è¿‘å‹åŠ›ä½ï¼‰
 *   â‘¡ Call Wallçš„IVåœ¨æœ€è¿‘3ä¸ªæ•°æ®ç‚¹æŒç»­ä¸Šå‡ï¼ˆå¸‚åœºé¢„æœŸæ³¢åŠ¨ç‡ä¸Šå‡ï¼‰
 *   â‘¢ Call Wallçš„Vol/OIæ¯”ç‡ > 0.3ï¼ˆè¯¥è¡Œæƒä»·æˆäº¤æ´»è·ƒï¼‰
 *   â†’ ä¸‰æ¡ä»¶åŒæ—¶æ»¡è¶³ï¼šé«˜é£é™©æŒ¤å‹ï¼Œåšå¸‚å•†éœ€å¤§é‡ä¹°å…¥å¯¹å†²ï¼Œå¯èƒ½å¼•å‘åŠ é€Ÿä¸Šæ¶¨
 *
 * çœ‹è·ŒæŒ¤å‹ï¼ˆä¸‹æ–¹ï¼‰ï¼š
 *   â‘  ç°ä»·è·Put Wall â‰¤ 1%
 *   â‘¡ Put Wallçš„IVæŒç»­ä¸Šå‡
 *   â‘¢ Put Wallçš„Vol/OIæ¯”ç‡ > 0.3
 *   â†’ ä¸‰æ¡ä»¶åŒæ—¶æ»¡è¶³ï¼šåšå¸‚å•†å–å‡ºå¯¹å†²ï¼Œå¯èƒ½åŠ é€Ÿä¸‹è·Œ
 */
function updateSqueezePanel(data, ivHistory) {
  const spot = data.spotPrice;
  const callWall = data.callWall;
  const putWall = data.putWall;

  // â”€â”€ çœ‹æ¶¨æŒ¤å‹ â”€â”€
  const upEl = document.getElementById('squeeze-up-signal');
  const upDetailEl = document.getElementById('squeeze-up-detail');
  if (callWall && spot) {
    const distPct = Math.abs((callWall - spot) / spot * 100);
    const callWallStrike = data.strikes.find(s => s.strike === callWall);
    const voiRatio = callWallStrike ? callWallStrike.volOIRatio : 0;

    // IVè¶‹åŠ¿
    let ivTrend = false;
    if (ivHistory && ivHistory.length >= 3) {
      const recent = ivHistory.slice(-3).map(h => h.callWallIV);
      ivTrend = recent[0] < recent[1] && recent[1] < recent[2];
    }

    const cond1 = distPct <= 1;
    const cond2 = ivTrend;
    const cond3 = voiRatio > 0.3;
    const score = [cond1, cond2, cond3].filter(Boolean).length;

    const signals = {
      3: { text: 'ğŸ”´ é«˜é£é™© â€” ä¸‰æ¡ä»¶æ»¡è¶³ï¼ŒæŒ¤å‹é£é™©æé«˜', cls: 'red' },
      2: { text: 'ğŸŸ¡ ä¸­ç­‰é£é™© â€” ä¸¤æ¡ä»¶æ»¡è¶³ï¼Œä¿æŒè­¦æƒ•', cls: 'yellow' },
      1: { text: 'âšª ä½é£é™© â€” ä»…ä¸€æ¡ä»¶æ»¡è¶³', cls: '' },
      0: { text: 'ğŸŸ¢ æ— ä¿¡å· â€” æ¡ä»¶æœªè§¦å‘', cls: '' },
    };
    const sig = signals[score];
    upEl.textContent = sig.text;
    upEl.className = `squeeze-signal ${sig.cls === 'red' ? 'red' : sig.cls === 'yellow' ? 'yellow' : ''}`;
    upEl.style.color = sig.cls === 'red' ? 'var(--red)' : sig.cls === 'yellow' ? 'var(--yellow)' : 'var(--text-secondary)';

    upDetailEl.innerHTML = `
      â‘  è·Call Wall ${fmtPrice(callWall)}ï¼š${distPct.toFixed(2)}%ï¼ˆé˜ˆå€¼â‰¤1%ï¼‰${cond1 ? ' âœ“' : ' âœ—'}<br>
      â‘¡ Call Wall IVè¶‹åŠ¿ï¼š${ivTrend ? 'æŒç»­ä¸Šå‡ âœ“' : 'æœªä¸Šå‡ âœ—'}<br>
      â‘¢ Vol/OIï¼š${voiRatio.toFixed(2)}ï¼ˆé˜ˆå€¼>0.3ï¼‰${cond3 ? ' âœ“' : ' âœ—'}
    `;
  }

  // â”€â”€ çœ‹è·ŒæŒ¤å‹ â”€â”€
  const downEl = document.getElementById('squeeze-down-signal');
  const downDetailEl = document.getElementById('squeeze-down-detail');
  if (putWall && spot) {
    const distPct = Math.abs((spot - putWall) / spot * 100);
    const putWallStrike = data.strikes.find(s => s.strike === putWall);
    const voiRatio = putWallStrike ? putWallStrike.volOIRatio : 0;

    let ivTrend = false;
    if (ivHistory && ivHistory.length >= 3) {
      const recent = ivHistory.slice(-3).map(h => h.putWallIV);
      ivTrend = recent[0] < recent[1] && recent[1] < recent[2];
    }

    const cond1 = distPct <= 1;
    const cond2 = ivTrend;
    const cond3 = voiRatio > 0.3;
    const score = [cond1, cond2, cond3].filter(Boolean).length;

    const signals = {
      3: { text: 'ğŸ”´ é«˜é£é™© â€” ä¸‰æ¡ä»¶æ»¡è¶³ï¼Œä¸‹è¡ŒæŒ¤å‹é£é™©æé«˜' },
      2: { text: 'ğŸŸ¡ ä¸­ç­‰é£é™© â€” ä¸¤æ¡ä»¶æ»¡è¶³ï¼Œä¿æŒè­¦æƒ•' },
      1: { text: 'âšª ä½é£é™© â€” ä»…ä¸€æ¡ä»¶æ»¡è¶³' },
      0: { text: 'ğŸŸ¢ æ— ä¿¡å· â€” æ¡ä»¶æœªè§¦å‘' },
    };
    downEl.textContent = signals[score].text;
    downEl.style.color = score === 3 ? 'var(--red)' : score === 2 ? 'var(--yellow)' : 'var(--text-secondary)';

    downDetailEl.innerHTML = `
      â‘  è·Put Wall ${fmtPrice(putWall)}ï¼š${distPct.toFixed(2)}%ï¼ˆé˜ˆå€¼â‰¤1%ï¼‰${cond1 ? ' âœ“' : ' âœ—'}<br>
      â‘¡ Put Wall IVè¶‹åŠ¿ï¼š${ivTrend ? 'æŒç»­ä¸Šå‡ âœ“' : 'æœªä¸Šå‡ âœ—'}<br>
      â‘¢ Vol/OIï¼š${voiRatio.toFixed(2)}ï¼ˆé˜ˆå€¼>0.3ï¼‰${cond3 ? ' âœ“' : ' âœ—'}
    `;
  }
}

// â”€â”€â”€ IV è¡Œæƒä»·æ ‡ç­¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderIVStrikeTags(data) {
  const container = document.getElementById('iv-strike-tags');
  container.innerHTML = '';

  const addTag = (key, label, type) => {
    const tag = document.createElement('div');
    tag.className = `iv-strike-tag ${state.doom.selectedStrikes.has(key) ? `selected-${type}` : ''}`;
    tag.textContent = label;
    tag.onclick = () => {
      if (state.doom.selectedStrikes.has(key)) {
        state.doom.selectedStrikes.delete(key);
        tag.className = 'iv-strike-tag';
      } else {
        state.doom.selectedStrikes.add(key);
        tag.className = `iv-strike-tag selected-${type}`;
      }
      renderDoom3(state.doom.ivHistory, data);
    };
    container.appendChild(tag);
  };

  if (data.callWall) addTag(`call:${data.callWall}`, `ğŸ“ˆ Call Wall ${data.callWall}`, 'call');
  if (data.putWall) addTag(`put:${data.putWall}`, `ğŸ“‰ Put Wall ${data.putWall}`, 'put');

  // è‡ªå®šä¹‰è¡Œæƒä»·æ ‡ç­¾
  state.doom.customStrikes.forEach(strike => {
    addTag(`custom:${strike}`, `â˜… ${strike}`, 'call');
  });
}

function addCustomIVStrike() {
  const val = parseFloat(document.getElementById('iv-custom-strike').value);
  if (isNaN(val)) return alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è¡Œæƒä»·');
  state.doom.customStrikes.add(val);
  state.doom.selectedStrikes.add(`custom:${val}`);
  if (state.doom.data) {
    renderIVStrikeTags(state.doom.data);
    renderDoom3(state.doom.ivHistory, state.doom.data);
  }
}

// â”€â”€â”€ Loading çŠ¶æ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setLoading(id, loading) {
  const el = document.getElementById(id);
  if (!el) return;
  if (loading) {
    el.classList.remove('hidden');
    el.querySelector('.loading-text').textContent = 'åŠ è½½ä¸­...';
  } else {
    el.classList.add('hidden');
  }
}

// â”€â”€â”€ è‡ªåŠ¨åˆ·æ–° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startAutoRefresh() {
  if (refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(async () => {
    const now = new Date();
    const et = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
    const day = et.getDay();
    const h = et.getHours(), m = et.getMinutes();
    const mins = h * 60 + m;
    const isMarket = day >= 1 && day <= 5 && mins >= 8 * 60 + 30 && mins < 16 * 60;

    if (!isMarket) return;

    // åˆ·æ–°GEXé¢æ¿
    for (const idx of [1, 2]) {
      const sym = document.getElementById(`gex-sym-${idx}`).value.trim().toUpperCase();
      if (sym && state.gex[idx].data) {
        fetchAndRenderGEX(idx, sym).catch(console.error);
      }
    }

    // åˆ·æ–°æœ«æ—¥é¢æ¿
    const doomSym = document.getElementById('doom-sym').value.trim().toUpperCase();
    if (doomSym && state.doom.data) {
      loadDoomsday().catch(console.error);
    }
  }, 15 * 60 * 1000); // 15åˆ†é’Ÿ
}

// â”€â”€â”€ åˆå§‹åŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// åˆå§‹åŒ–æ˜¾ç¤ºç©ºå›¾è¡¨å ä½ç¬¦
function initEmptyState(canvasId, message) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const loadingEl = document.getElementById('loading-' + canvasId.replace('chart-', ''));
  if (loadingEl) {
    loadingEl.querySelector('.loading-text').textContent = message;
  }
}

document.addEventListener('DOMContentLoaded', () => {
  // è®©åŠ è½½å±‚æ˜¾ç¤º"ç­‰å¾…è¾“å…¥"
  ['gex-1', 'gex-2'].forEach(id => {
    const el = document.getElementById(`loading-${id}`);
    if (el) el.querySelector('.loading-text').textContent = 'è¯·è¾“å…¥æ ‡çš„ä»£ç åç‚¹å‡»åŠ è½½';
  });
  ['doom-1', 'doom-2', 'doom-3'].forEach(id => {
    const el = document.getElementById(`loading-doom-${id}`);
    if (el) el.querySelector('.loading-text').textContent = 'è¯·åœ¨ä¸Šæ–¹è¾“å…¥æ ‡çš„ä»£ç ååŠ è½½';
  });

  startAutoRefresh();

  // å›è½¦å¿«æ·é”®
  document.getElementById('gex-sym-1').addEventListener('keydown', e => { if (e.key === 'Enter') loadGEX(1); });
  document.getElementById('gex-sym-2').addEventListener('keydown', e => { if (e.key === 'Enter') loadGEX(2); });
  document.getElementById('doom-sym').addEventListener('keydown', e => { if (e.key === 'Enter') loadDoomsday(); });
});
</script>
</body>
</html>
