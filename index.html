<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GEX Monitor</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Syne:wght@600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg0:#07090d; --bg1:#0d1117; --bg2:#111823; --bg3:#18232f;
  --border:#1c2a3a; --border2:#243548;
  --green:#00d47e; --green2:#00d47e30; --green3:#00d47e15;
  --red:#f03e52;   --red2:#f03e5230;   --red3:#f03e5215;
  --yellow:#f5c518; --yellow2:#f5c51830;
  --blue:#3b9eff;  --blue2:#3b9eff25;
  --purple:#9b6dff;
  --t1:#dce8f5; --t2:#7a8fa5; --t3:#3a4f63;
  --mono:'JetBrains Mono',monospace;
  --disp:'Syne',sans-serif;
  --r:6px; --r2:10px;
}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{background:var(--bg0);color:var(--t1);font-family:var(--mono);font-size:12px;line-height:1.5;min-height:100vh}

/* â”€â”€ Header â”€â”€ */
header{position:sticky;top:0;z-index:100;height:52px;background:var(--bg1);border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;padding:0 20px}
.logo{font-family:var(--disp);font-size:17px;font-weight:800;display:flex;align-items:center;gap:9px}
.logo-pulse{width:7px;height:7px;background:var(--green);border-radius:50%;
  box-shadow:0 0 8px var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(.8)}}
.hdr-right{display:flex;align-items:center;gap:16px}
.mkt-status{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--t2)}
.dot{width:6px;height:6px;border-radius:50%;background:var(--t3)}
.dot.open{background:var(--green);box-shadow:0 0 5px var(--green)}
.dot.closed{background:var(--red)}
#et-clock{font-size:11px;color:var(--t2);font-variant-numeric:tabular-nums}

/* â”€â”€ Tabs â”€â”€ */
.tabs{display:flex;background:var(--bg1);border-bottom:1px solid var(--border);padding:0 20px}
.tab{background:none;border:none;border-bottom:2px solid transparent;padding:11px 18px;
  font-family:var(--disp);font-size:12px;font-weight:700;color:var(--t3);cursor:pointer;
  letter-spacing:.6px;text-transform:uppercase;transition:.15s}
.tab:hover{color:var(--t2)}
.tab.active{color:var(--green);border-bottom-color:var(--green)}
.panel{display:none;padding:20px}
.panel.active{display:block}

/* â”€â”€ Card â”€â”€ */
.card{background:var(--bg1);border:1px solid var(--border);border-radius:var(--r2);overflow:hidden;margin-bottom:18px}
.card:last-child{margin-bottom:0}

/* â”€â”€ Symbol input bar â”€â”€ */
.sym-bar{display:flex;align-items:center;gap:10px;padding:12px 18px;
  background:var(--bg2);border-bottom:1px solid var(--border);flex-wrap:wrap}
.sym-num{font-family:var(--disp);font-size:10px;font-weight:800;color:var(--t3);
  width:18px;text-align:center;letter-spacing:1px}
.sym-input{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);
  padding:5px 11px;font-family:var(--mono);font-size:14px;font-weight:700;
  color:var(--t1);width:96px;text-transform:uppercase;letter-spacing:1px;outline:none;transition:.15s}
.sym-input:focus{border-color:var(--green);box-shadow:0 0 0 2px var(--green3)}
.btn{border:none;border-radius:var(--r);padding:5px 15px;font-family:var(--disp);
  font-size:11px;font-weight:800;cursor:pointer;letter-spacing:.5px;text-transform:uppercase;transition:.15s}
.btn-green{background:var(--green);color:#000}
.btn-green:hover{filter:brightness(1.1)}
.btn-red{background:var(--red);color:#fff}
.btn-red:hover{filter:brightness(1.1)}
.btn-outline{background:none;border:1px solid var(--border);color:var(--t2);font-family:var(--mono);font-size:10px}
.btn-outline:hover{border-color:var(--green);color:var(--green)}
.upd-time{font-size:10px;color:var(--t3);margin-left:auto;font-variant-numeric:tabular-nums}

/* â”€â”€ Metrics bar â”€â”€ */
.metrics{display:flex;border-bottom:1px solid var(--border);overflow-x:auto;scrollbar-width:none}
.metric{flex:1;min-width:90px;padding:9px 15px;border-right:1px solid var(--border)}
.metric:last-child{border-right:none}
.mlabel{font-size:9px;color:var(--t3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:3px}
.mval{font-size:14px;font-weight:700;font-variant-numeric:tabular-nums;color:var(--t1)}
.mval.g{color:var(--green)} .mval.r{color:var(--red)} .mval.y{color:var(--yellow)} .mval.b{color:var(--blue)}

/* â”€â”€ Expiry selector â”€â”€ */
.expiry-bar{border-bottom:1px solid var(--border)}
.expiry-toggle{display:flex;align-items:center;justify-content:space-between;padding:9px 18px;
  background:var(--bg2);cursor:pointer;user-select:none;transition:.15s}
.expiry-toggle:hover{background:var(--bg3)}
.expiry-tlabel{font-size:11px;font-weight:700;color:var(--t2);display:flex;align-items:center;gap:8px;font-family:var(--disp)}
.exp-summary{font-size:10px;color:var(--green)}
.chevron{font-size:9px;color:var(--t3);transition:transform .2s}
.chevron.open{transform:rotate(180deg)}
.expiry-body{display:none;padding:12px 18px;background:var(--bg1);border-top:1px solid var(--border)}
.expiry-body.open{display:block}
.exp-grid{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:9px}
.exp-chip{display:flex;align-items:center;gap:4px;padding:3px 9px;border-radius:4px;
  background:var(--bg2);border:1px solid var(--border);font-size:10px;font-family:var(--mono);
  color:var(--t2);cursor:pointer;transition:.15s;user-select:none}
.exp-chip:hover{border-color:var(--border2);color:var(--t1)}
.exp-chip.sel{background:var(--green2);border-color:var(--green);color:var(--green)}
.exp-chip input{width:11px;height:11px;accent-color:var(--green)}
.exp-actions{display:flex;gap:6px}

/* â”€â”€ Chart area â”€â”€ */
.chart-area{padding:14px;background:var(--bg1)}
.chart-controls{display:flex;align-items:center;gap:7px;margin-bottom:10px;flex-wrap:wrap}
.ctl-label{font-size:10px;color:var(--t3)}
.zoom-btn{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r);
  padding:3px 10px;font-size:10px;color:var(--t2);cursor:pointer;font-family:var(--mono);transition:.15s}
.zoom-btn:hover{border-color:var(--green);color:var(--green)}
.zoom-btn.active{background:var(--green2);border-color:var(--green);color:var(--green)}
.chart-wrap{position:relative}
.overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;
  justify-content:center;background:var(--bg1);z-index:10;gap:10px}
.overlay.hidden{display:none}
.spinner{width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--green);
  border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.ovl-text{font-size:11px;color:var(--t3)}

/* â”€â”€ Doom section â”€â”€ */
.doom-input{display:flex;align-items:center;gap:10px;padding:14px 20px;
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--r2);
  margin-bottom:18px;flex-wrap:wrap}
.doom-label{font-family:var(--disp);font-size:11px;font-weight:800;color:var(--red);
  text-transform:uppercase;letter-spacing:1px}
.doom-metrics{display:flex;gap:0;border:1px solid var(--border);border-radius:var(--r);
  overflow:hidden;margin-left:auto}
.doom-metrics .metric{min-width:80px;padding:7px 12px}

/* â”€â”€ Unit headers â”€â”€ */
.unit-hdr{display:flex;align-items:center;justify-content:space-between;padding:11px 18px;
  background:var(--bg2);border-bottom:1px solid var(--border)}
.unit-title{font-family:var(--disp);font-size:12px;font-weight:700;color:var(--t1);
  display:flex;align-items:center;gap:8px}
.unit-num{width:21px;height:21px;background:var(--red2);color:var(--red);border-radius:50%;
  display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800}

/* â”€â”€ IV section â”€â”€ */
.iv-tags{display:flex;flex-wrap:wrap;gap:5px;padding:10px 18px;border-bottom:1px solid var(--border);background:var(--bg2)}
.iv-tag{display:flex;align-items:center;gap:4px;padding:3px 9px;border-radius:4px;
  border:1px solid var(--border);font-size:10px;font-family:var(--mono);
  color:var(--t2);background:var(--bg1);cursor:pointer;transition:.15s}
.iv-tag.sc{background:var(--green2);border-color:var(--green);color:var(--green)}
.iv-tag.sp{background:var(--red2);border-color:var(--red);color:var(--red)}
.iv-custom{display:flex;align-items:center;gap:7px;padding:8px 18px;
  border-bottom:1px solid var(--border);background:var(--bg2)}
.iv-custom-label{font-size:10px;color:var(--t3)}
.iv-num-input{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);
  padding:4px 9px;font-family:var(--mono);font-size:12px;color:var(--t1);width:80px;outline:none}
.iv-num-input:focus{border-color:var(--purple)}
.btn-purple{background:var(--purple);color:#fff;font-family:var(--disp);font-size:10px;font-weight:800}
.btn-purple:hover{filter:brightness(1.15)}

/* â”€â”€ Squeeze panel â”€â”€ */
.squeeze{margin:12px 16px;padding:12px 16px;background:var(--bg2);
  border-radius:var(--r);border:1px solid var(--border)}
.sq-title{font-family:var(--disp);font-size:10px;font-weight:800;color:var(--t3);
  text-transform:uppercase;letter-spacing:.8px;margin-bottom:9px}
.sq-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.sq-item{padding:9px 12px;border-radius:var(--r);border:1px solid var(--border);background:var(--bg1)}
.sq-dir{font-size:9px;font-weight:800;text-transform:uppercase;letter-spacing:.8px;
  margin-bottom:4px;font-family:var(--disp)}
.sq-dir.up{color:var(--green)} .sq-dir.dn{color:var(--red)}
.sq-signal{font-size:12px;font-weight:700;color:var(--t2);margin-bottom:3px}
.sq-detail{font-size:10px;color:var(--t3);line-height:1.6}

/* â”€â”€ Scrollbar â”€â”€ */
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.fade{animation:fadeIn .25s ease forwards}
@media(max-width:768px){.sq-grid{grid-template-columns:1fr}.doom-metrics{display:none}}
</style>
</head>
<body>

<header>
  <div class="logo"><div class="logo-pulse"></div>GEX Monitor</div>
  <div class="hdr-right">
    <div class="mkt-status"><div class="dot" id="mkt-dot"></div><span id="mkt-txt">--</span></div>
    <div id="et-clock">--:--:-- ET</div>
  </div>
</header>

<div class="tabs">
  <button class="tab active" onclick="switchTab('gex',this)">GEX è§‚å¯Ÿ</button>
  <button class="tab" onclick="switchTab('doom',this)">æœ«æ—¥è§‚å¯Ÿ</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ç¬¬ä¸€éƒ¨åˆ†ï¼šGEX è§‚å¯Ÿ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="panel active" id="tab-gex">

  <!-- æ ‡çš„ 1 -->
  <div class="card" id="card-1">
    <div class="sym-bar">
      <div class="sym-num">01</div>
      <input class="sym-input" id="sym-1" placeholder="NVDA" maxlength="8" value="NVDA">
      <button class="btn btn-green" onclick="loadGEX(1)">åŠ è½½</button>
      <span class="upd-time" id="upd-1">æœªåŠ è½½</span>
    </div>
    <div class="metrics" id="metrics-1">
      <div class="metric"><div class="mlabel">ç°ä»· Spot</div><div class="mval" id="m1-spot">--</div></div>
      <div class="metric"><div class="mlabel">Gamma Flip</div><div class="mval y" id="m1-flip">--</div></div>
      <div class="metric"><div class="mlabel">Call Wall</div><div class="mval g" id="m1-cw">--</div></div>
      <div class="metric"><div class="mlabel">Put Wall</div><div class="mval r" id="m1-pw">--</div></div>
      <div class="metric"><div class="mlabel">ATM IV</div><div class="mval b" id="m1-iv">--</div></div>
      <div class="metric"><div class="mlabel">Gamma çŠ¶æ€</div><div class="mval" id="m1-pos">--</div></div>
    </div>
    <div class="expiry-bar">
      <div class="expiry-toggle" onclick="toggleExp(1)">
        <div class="expiry-tlabel">ğŸ“… åˆ°æœŸæ—¥ç­›é€‰ <span class="exp-summary" id="exp-sum-1">--</span></div>
        <div style="display:flex;align-items:center;gap:7px">
          <button class="btn btn-outline" onclick="event.stopPropagation();applyExp(1)">åº”ç”¨</button>
          <div class="chevron" id="exp-chev-1">â–¼</div>
        </div>
      </div>
      <div class="expiry-body" id="exp-body-1">
        <div class="exp-grid" id="exp-grid-1"><span style="color:var(--t3)">è¯·å…ˆåŠ è½½æ•°æ®</span></div>
        <div class="exp-actions">
          <button class="btn btn-outline" onclick="selAllExp(1,true)">å…¨é€‰</button>
          <button class="btn btn-outline" onclick="selAllExp(1,false)">æ¸…é™¤</button>
          <button class="btn btn-outline" onclick="selThisMonth(1)">æœ¬æœˆ</button>
          <button class="btn btn-outline" onclick="selNextMonth(1)">æ¬¡æœˆ</button>
        </div>
      </div>
    </div>
    <div class="chart-area">
      <div class="chart-controls">
        <span class="ctl-label">æ˜¾ç¤ºèŒƒå›´ï¼š</span>
        <button class="zoom-btn active" id="z1-20" onclick="setZoom(1,20)">SpotÂ±20</button>
        <button class="zoom-btn" id="z1-40" onclick="setZoom(1,40)">SpotÂ±40</button>
        <button class="zoom-btn" id="z1-0"  onclick="setZoom(1,0)">å…¨éƒ¨</button>
      </div>
      <div class="chart-wrap" style="height:340px">
        <div class="overlay" id="ov-1"><div class="spinner"></div><div class="ovl-text" id="ovt-1">è¯·è¾“å…¥æ ‡çš„åç‚¹å‡»åŠ è½½</div></div>
        <canvas id="ch-1"></canvas>
      </div>
    </div>
  </div>

  <!-- æ ‡çš„ 2 -->
  <div class="card" id="card-2">
    <div class="sym-bar">
      <div class="sym-num">02</div>
      <input class="sym-input" id="sym-2" placeholder="SPY" maxlength="8" value="SPY">
      <button class="btn btn-green" onclick="loadGEX(2)">åŠ è½½</button>
      <span class="upd-time" id="upd-2">æœªåŠ è½½</span>
    </div>
    <div class="metrics" id="metrics-2">
      <div class="metric"><div class="mlabel">ç°ä»· Spot</div><div class="mval" id="m2-spot">--</div></div>
      <div class="metric"><div class="mlabel">Gamma Flip</div><div class="mval y" id="m2-flip">--</div></div>
      <div class="metric"><div class="mlabel">Call Wall</div><div class="mval g" id="m2-cw">--</div></div>
      <div class="metric"><div class="mlabel">Put Wall</div><div class="mval r" id="m2-pw">--</div></div>
      <div class="metric"><div class="mlabel">ATM IV</div><div class="mval b" id="m2-iv">--</div></div>
      <div class="metric"><div class="mlabel">Gamma çŠ¶æ€</div><div class="mval" id="m2-pos">--</div></div>
    </div>
    <div class="expiry-bar">
      <div class="expiry-toggle" onclick="toggleExp(2)">
        <div class="expiry-tlabel">ğŸ“… åˆ°æœŸæ—¥ç­›é€‰ <span class="exp-summary" id="exp-sum-2">--</span></div>
        <div style="display:flex;align-items:center;gap:7px">
          <button class="btn btn-outline" onclick="event.stopPropagation();applyExp(2)">åº”ç”¨</button>
          <div class="chevron" id="exp-chev-2">â–¼</div>
        </div>
      </div>
      <div class="expiry-body" id="exp-body-2">
        <div class="exp-grid" id="exp-grid-2"><span style="color:var(--t3)">è¯·å…ˆåŠ è½½æ•°æ®</span></div>
        <div class="exp-actions">
          <button class="btn btn-outline" onclick="selAllExp(2,true)">å…¨é€‰</button>
          <button class="btn btn-outline" onclick="selAllExp(2,false)">æ¸…é™¤</button>
          <button class="btn btn-outline" onclick="selThisMonth(2)">æœ¬æœˆ</button>
          <button class="btn btn-outline" onclick="selNextMonth(2)">æ¬¡æœˆ</button>
        </div>
      </div>
    </div>
    <div class="chart-area">
      <div class="chart-controls">
        <span class="ctl-label">æ˜¾ç¤ºèŒƒå›´ï¼š</span>
        <button class="zoom-btn active" id="z2-20" onclick="setZoom(2,20)">SpotÂ±20</button>
        <button class="zoom-btn" id="z2-40" onclick="setZoom(2,40)">SpotÂ±40</button>
        <button class="zoom-btn" id="z2-0"  onclick="setZoom(2,0)">å…¨éƒ¨</button>
      </div>
      <div class="chart-wrap" style="height:340px">
        <div class="overlay" id="ov-2"><div class="spinner"></div><div class="ovl-text" id="ovt-2">è¯·è¾“å…¥æ ‡çš„åç‚¹å‡»åŠ è½½</div></div>
        <canvas id="ch-2"></canvas>
      </div>
    </div>
  </div>

</div><!-- /tab-gex -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ç¬¬äºŒéƒ¨åˆ†ï¼šæœ«æ—¥è§‚å¯Ÿ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="panel" id="tab-doom">

  <div class="doom-input">
    <div class="doom-label">âš¡ æœ«æ—¥è§‚å¯Ÿ</div>
    <input class="sym-input" id="doom-sym" placeholder="SPY" maxlength="8" value="SPY">
    <button class="btn btn-red" onclick="loadDoom()">åŠ è½½</button>
    <span class="upd-time" id="doom-upd">æœªåŠ è½½</span>
    <div class="doom-metrics">
      <div class="metric"><div class="mlabel">åˆ°æœŸæ—¥</div><div class="mval y" id="dm-exp">--</div></div>
      <div class="metric"><div class="mlabel">ç°ä»·</div><div class="mval" id="dm-spot">--</div></div>
      <div class="metric"><div class="mlabel">Flipç‚¹</div><div class="mval y" id="dm-flip">--</div></div>
      <div class="metric"><div class="mlabel">Call Wall</div><div class="mval g" id="dm-cw">--</div></div>
      <div class="metric"><div class="mlabel">Put Wall</div><div class="mval r" id="dm-pw">--</div></div>
      <div class="metric"><div class="mlabel">ATM IV</div><div class="mval b" id="dm-iv">--</div></div>
    </div>
  </div>

  <!-- å•å…ƒâ‘  0DTE GEXåˆ†å¸ƒ -->
  <div class="card">
    <div class="unit-hdr">
      <div class="unit-title"><div class="unit-num">1</div>0DTE GEX åˆ†å¸ƒï¼ˆæœ€è¿‘åˆ°æœŸæ—¥ï¼‰</div>
      <div style="display:flex;gap:6px">
        <button class="zoom-btn active" id="dz-20" onclick="setDZoom(20)">SpotÂ±20</button>
        <button class="zoom-btn" id="dz-40" onclick="setDZoom(40)">SpotÂ±40</button>
        <button class="zoom-btn" id="dz-0"  onclick="setDZoom(0)">å…¨éƒ¨</button>
      </div>
    </div>
    <div class="chart-area">
      <div class="chart-wrap" style="height:300px">
        <div class="overlay" id="ov-d1"><div class="spinner"></div><div class="ovl-text">è¯·åŠ è½½æ•°æ®</div></div>
        <canvas id="ch-d1"></canvas>
      </div>
    </div>
  </div>

  <!-- å•å…ƒâ‘¡ Vol/OIï¼ˆä¸ä¸Šå›¾Xè½´ä¸¥æ ¼å¯¹é½ï¼‰ -->
  <div class="card">
    <div class="unit-hdr">
      <div class="unit-title"><div class="unit-num">2</div>æˆäº¤é‡ / æœªå¹³ä»“åˆçº¦ï¼ˆVol/OIï¼‰çƒ­åŠ›å›¾</div>
      <div style="font-size:10px;color:var(--t3)">æŸ±è¶Šé«˜ = è¯¥è¡Œæƒä»·è¶Šæ´»è·ƒï¼›ä¸ä¸Šå›¾Xè½´å¯¹é½</div>
    </div>
    <div class="chart-area" style="padding-top:0">
      <!-- æ³¨æ„ï¼šç§»é™¤padding-topï¼Œè®©ä¸¤å›¾Xè½´å°½é‡å¯¹é½ -->
      <div class="chart-wrap" style="height:160px">
        <div class="overlay" id="ov-d2"><div class="spinner"></div><div class="ovl-text">è¯·åŠ è½½æ•°æ®</div></div>
        <canvas id="ch-d2"></canvas>
      </div>
    </div>
  </div>

  <!-- å•å…ƒâ‘¢ æ—¥å†…IV -->
  <div class="card">
    <div class="unit-hdr">
      <div class="unit-title"><div class="unit-num">3</div>å…³é”®è¡Œæƒä»· æ—¥å†…éšå«æ³¢åŠ¨ç‡å˜åŒ–</div>
    </div>
    <div class="iv-tags" id="iv-tags">
      <span style="color:var(--t3);font-size:10px">åŠ è½½åè‡ªåŠ¨æ˜¾ç¤ºCall/Put Wallè¡Œæƒä»·</span>
    </div>
    <div class="iv-custom">
      <span class="iv-custom-label">è‡ªå®šä¹‰è¡Œæƒä»·ï¼š</span>
      <input class="iv-num-input" id="iv-custom" type="number" placeholder="190" step="0.5">
      <button class="btn btn-purple" onclick="addCustomIV()">+ æ·»åŠ </button>
    </div>
    <div class="chart-area">
      <div class="chart-wrap" style="height:220px">
        <div class="overlay" id="ov-d3"><div class="spinner"></div><div class="ovl-text">è¯·åŠ è½½æ•°æ®</div></div>
        <canvas id="ch-d3"></canvas>
      </div>
    </div>
    <!-- Gamma Squeeze åˆ¤æ–­ -->
    <div class="squeeze">
      <div class="sq-title">âš¡ Gamma Squeeze åˆ¤æ–­ï¼ˆä¸‰æ¡ä»¶åŒæ—¶æ»¡è¶³ = é«˜é£é™©ï¼‰</div>
      <div class="sq-grid">
        <div class="sq-item">
          <div class="sq-dir up">â–² çœ‹æ¶¨æŒ¤å‹ï¼ˆçªç ´Call Wallï¼‰</div>
          <div class="sq-signal" id="sq-up">ç­‰å¾…æ•°æ®...</div>
          <div class="sq-detail" id="sq-up-d">â‘ ç°ä»·è·Call Wallâ‰¤1% â‘¡Call Wall IVæŒç»­3æœŸä¸Šå‡ â‘¢Call Wall Vol/OI>0.3</div>
        </div>
        <div class="sq-item">
          <div class="sq-dir dn">â–¼ çœ‹è·ŒæŒ¤å‹ï¼ˆçªç ´Put Wallï¼‰</div>
          <div class="sq-signal" id="sq-dn">ç­‰å¾…æ•°æ®...</div>
          <div class="sq-detail" id="sq-dn-d">â‘ ç°ä»·è·Put Wallâ‰¤1% â‘¡Put Wall IVæŒç»­3æœŸä¸Šå‡ â‘¢Put Wall Vol/OI>0.3</div>
        </div>
      </div>
    </div>
  </div>

</div><!-- /tab-doom -->

<script>
// â•â•â• é…ç½® â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// éƒ¨ç½²åæ›¿æ¢ä¸ºä½ çš„Worker URL
const API = 'https://gex-monitor-worker.fibitrader.workers.dev';

// â•â•â• å…¨å±€çŠ¶æ€ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  gex: {
    1: { data:null, allDates:[], selDates:[], zoom:20, chart:null },
    2: { data:null, allDates:[], selDates:[], zoom:20, chart:null },
  },
  doom: {
    data:null, ivHistory:[], selStrikes:new Set(), customStrikes:new Set(),
    zoom:20, charts:{d1:null,d2:null,d3:null},
    sharedLabels:[], // å…±äº«Xè½´æ ‡ç­¾ï¼ˆå•å…ƒâ‘ â‘¡å¯¹é½ç”¨ï¼‰
  },
};

// â•â•â• Chart.js å…¨å±€é…ç½® â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Chart.defaults.color = '#7a8fa5';
Chart.defaults.borderColor = '#1c2a3a';
Chart.defaults.font.family = "'JetBrains Mono',monospace";
Chart.defaults.font.size = 10;

// â•â•â• æ—¶é’Ÿ & å¸‚åœºçŠ¶æ€ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tick() {
  const now = new Date();
  const et = new Date(now.toLocaleString('en-US',{timeZone:'America/New_York'}));
  const hm = et.toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
  document.getElementById('et-clock').textContent = hm + ' ET';
  const d=et.getDay(), m=et.getHours()*60+et.getMinutes();
  const open=d>=1&&d<=5&&m>=510&&m<960;
  const pre =d>=1&&d<=5&&m>=510&&m<570;
  const dot=document.getElementById('mkt-dot'), txt=document.getElementById('mkt-txt');
  if(!d||d===6){dot.className='dot closed';txt.textContent='å‘¨æœ«ä¼‘å¸‚';}
  else if(open&&pre){dot.className='dot open';txt.textContent='ç›˜å‰ç›‘æ§ä¸­';}
  else if(open){dot.className='dot open';txt.textContent='ç›˜ä¸­';}
  else{dot.className='dot closed';txt.textContent='å·²æ”¶ç›˜';}
}
setInterval(tick,1000); tick();

// â•â•â• Tabåˆ‡æ¢ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(id, el) {
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('tab-'+id).classList.add('active');
}

// â•â•â• API â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function apiFetch(path) {
  const r = await fetch(API + path);
  if (!r.ok) { const e=await r.json().catch(()=>({error:r.statusText})); throw new Error(e.error||'HTTP '+r.status); }
  return r.json();
}

// â•â•â• æ ¼å¼åŒ– â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const fp = v => v!=null ? Number(v).toFixed(2) : '--';
const fiv = v => v!=null && v>0 ? Number(v).toFixed(2)+'%' : '--';
function fgex(v) {
  const a=Math.abs(v);
  if(a>=1e9) return (v/1e9).toFixed(3)+'B';
  if(a>=1e6) return (v/1e6).toFixed(2)+'M';
  if(a>=1e3) return (v/1e3).toFixed(1)+'K';
  return v.toFixed(0);
}

// â•â•â• overlay â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showOverlay(id, msg) {
  const el=document.getElementById(id); if(!el)return;
  el.classList.remove('hidden');
  const t=el.querySelector('.ovl-text'); if(t)t.textContent=msg||'åŠ è½½ä¸­...';
}
function hideOverlay(id) {
  const el=document.getElementById(id); if(el) el.classList.add('hidden');
}

// â•â•â• GEXå›¾è¡¨æ„å»ºï¼ˆæ¯è¡Œæƒä»·ä¸€æ ¹å‡€GEXæŸ±ï¼‰ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildGEXChart(canvas, data, spot, flip, callWall, putWall, zoom, existingChart) {
  if (existingChart) existingChart.destroy();

  let strikes = data.strikes;
  if (zoom>0 && spot) {
    strikes = strikes.filter(s => Math.abs(s.strike-spot) <= zoom);
  }
  // è‹¥è¿‡æ»¤åæ•°æ®å¤ªå°‘ï¼Œé€€å›å…¨éƒ¨
  if (strikes.length < 3) strikes = data.strikes;

  const labels = strikes.map(s => s.strike);
  const netGEX  = strikes.map(s => s.netGEX / 1e6);  // å•ä½M

  // èšåˆGEXæ›²çº¿
  const aggMap = {};
  data.strikes.forEach((s,i) => { aggMap[s.strike] = data.aggregateGEX[i] / 1e9; });
  const aggVals = strikes.map(s => aggMap[s.strike] ?? 0);

  // æŸ±é¢œè‰²ï¼šå‡€GEXæ­£ç»¿è´Ÿçº¢
  const barColors = netGEX.map(v => v>=0 ? '#00d47e99' : '#f03e5299');
  const barBorder = netGEX.map(v => v>=0 ? '#00d47e' : '#f03e52');

  // æ ‡æ³¨
  const annotations = {};

  // Gamma Flip çº¢è‰²è™šçº¿
  if (flip!=null) {
    annotations.flip = {
      type:'line', xMin:flip, xMax:flip,
      borderColor:'#f03e52', borderWidth:1.5, borderDash:[5,4],
      label:{display:true, content:`Flip ${fp(flip)}`, position:'start',
             color:'#f03e52', backgroundColor:'transparent', font:{size:9,weight:'bold'}}
    };
  }

  // Spot ç»¿è‰²å®çº¿
  if (spot) {
    annotations.spot = {
      type:'line', xMin:spot, xMax:spot,
      borderColor:'#00d47e', borderWidth:2,
      label:{display:true, content:`${fp(spot)}`, position:'start',
             color:'#00d47e', backgroundColor:'transparent', font:{size:9,weight:'bold'}}
    };
  }

  // Call Wall ç»¿è™šçº¿ï¼ˆåœ¨æ˜¾ç¤ºèŒƒå›´å†…æ‰æ ‡æ³¨ï¼‰
  if (callWall && (!zoom || Math.abs(callWall-spot)<=zoom+5)) {
    annotations.cw = {
      type:'line', xMin:callWall, xMax:callWall,
      borderColor:'#00d47e70', borderWidth:1, borderDash:[4,3],
      label:{display:true, content:`CW ${callWall}`, position:'end',
             color:'#00d47e', backgroundColor:'transparent', font:{size:9}}
    };
  }

  // Put Wall çº¢è™šçº¿
  if (putWall && (!zoom || Math.abs(putWall-spot)<=zoom+5)) {
    annotations.pw = {
      type:'line', xMin:putWall, xMax:putWall,
      borderColor:'#f03e5270', borderWidth:1, borderDash:[4,3],
      label:{display:true, content:`PW ${putWall}`, position:'end',
             color:'#f03e52', backgroundColor:'transparent', font:{size:9}}
    };
  }

  return new Chart(canvas, {
    type:'bar',
    data:{
      labels,
      datasets:[
        {
          label:'å‡€ GEX (M)',
          data: netGEX,
          backgroundColor: barColors,
          borderColor: barBorder,
          borderWidth: 1,
          yAxisID:'y',
        },
        {
          label:'èšåˆ GEX (B)',
          data: aggVals,
          type:'line',
          yAxisID:'y2',
          borderColor:'#3b9eff',
          borderWidth:2,
          pointRadius:0,
          tension:0.4,
          fill:false,
        }
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{labels:{boxWidth:12,padding:14,color:'#7a8fa5'}},
        annotation:{annotations},
        tooltip:{
          backgroundColor:'#111823', borderColor:'#1c2a3a', borderWidth:1,
          callbacks:{
            label:ctx => {
              if(ctx.datasetIndex===1) return `èšåˆGEX: ${ctx.raw.toFixed(4)}B`;
              const s = strikes[ctx.dataIndex];
              const sign = s?.netGEX>=0?'+':'-';
              return [`å‡€GEX: ${sign}${Math.abs(ctx.raw).toFixed(2)}M`,
                      `Call GEX: +${(s?.callGEX/1e6||0).toFixed(2)}M`,
                      `Put  GEX: ${((s?.putGEX||0)/1e6).toFixed(2)}M`,
                      `Call OI: ${(s?.callOI||0).toLocaleString()}`,
                      `Put  OI: ${(s?.putOI||0).toLocaleString()}`];
            }
          }
        }
      },
      scales:{
        x:{type:'category', grid:{color:'#1c2a3a60'},
           ticks:{maxRotation:45,autoSkip:true,maxTicksLimit:25,color:'#3a4f63'}},
        y:{position:'left', grid:{color:'#1c2a3a60'},
           title:{display:true,text:'å‡€ GEX (M)',color:'#3a4f63'},
           ticks:{color:'#7a8fa5'}},
        y2:{position:'right', grid:{display:false},
            title:{display:true,text:'èšåˆ GEX (B)',color:'#3b9eff50'},
            ticks:{color:'#3b9eff80'}},
      }
    }
  });
}

// â•â•â• åŠ è½½GEX â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadGEX(idx) {
  const sym = document.getElementById(`sym-${idx}`).value.trim().toUpperCase();
  if (!sym) return alert('è¯·è¾“å…¥æ ‡çš„ä»£ç ');
  showOverlay(`ov-${idx}`, 'è·å–åˆ°æœŸæ—¥...');
  try {
    const expData = await apiFetch(`/api/expirations?symbol=${encodeURIComponent(sym)}`);
    S.gex[idx].allDates = expData.dates;
    // é»˜è®¤é€‰å½“æœˆ+æ¬¡æœˆ
    const now=new Date();
    const m0=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    const m1=`${now.getFullYear()}-${String(now.getMonth()+2).padStart(2,'0')}`;
    S.gex[idx].selDates = expData.dates.filter(d=>d.startsWith(m0)||d.startsWith(m1));
    renderExpChips(idx, expData.dates, S.gex[idx].selDates);
    await fetchRenderGEX(idx, sym);
  } catch(e) {
    showOverlay(`ov-${idx}`, 'åŠ è½½å¤±è´¥: '+e.message);
    console.error(e);
  }
}

async function fetchRenderGEX(idx, sym) {
  if (!sym) sym = document.getElementById(`sym-${idx}`).value.trim().toUpperCase();
  showOverlay(`ov-${idx}`, 'åŠ è½½ä¸­...');
  try {
    const sel = S.gex[idx].selDates;
    const dp = sel.length ? `&dates=${sel.join(',')}` : '';
    const data = await apiFetch(`/api/gex?symbol=${encodeURIComponent(sym)}${dp}`);
    S.gex[idx].data = data;

    // æ›´æ–°æŒ‡æ ‡
    document.getElementById(`m${idx}-spot`).textContent = fp(data.spotPrice);
    document.getElementById(`m${idx}-flip`).textContent = fp(data.gammaFlip);
    document.getElementById(`m${idx}-cw`).textContent   = fp(data.callWall);
    document.getElementById(`m${idx}-pw`).textContent   = fp(data.putWall);
    document.getElementById(`m${idx}-iv`).textContent   = fiv(data.atmIV);
    document.getElementById(`upd-${idx}`).textContent   = data.updatedAt;

    const posEl = document.getElementById(`m${idx}-pos`);
    if (data.spotPrice!=null && data.gammaFlip!=null) {
      if (data.spotPrice >= data.gammaFlip) {
        posEl.textContent='æ­£ Gamma â–²'; posEl.className='mval g';
      } else {
        posEl.textContent='è´Ÿ Gamma â–¼'; posEl.className='mval r';
      }
    }

    // ç”»å›¾
    const canvas = document.getElementById(`ch-${idx}`);
    S.gex[idx].chart = buildGEXChart(canvas, data, data.spotPrice, data.gammaFlip,
      data.callWall, data.putWall, S.gex[idx].zoom, S.gex[idx].chart);
    hideOverlay(`ov-${idx}`);
  } catch(e) {
    showOverlay(`ov-${idx}`, 'é”™è¯¯: '+e.message);
    console.error(e);
  }
}

// â•â•â• ç¼©æ”¾ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setZoom(idx, z) {
  S.gex[idx].zoom = z;
  [20,40,0].forEach(v => {
    const btn=document.getElementById(`z${idx}-${v}`);
    if(btn) btn.classList.toggle('active', v===z);
  });
  if (S.gex[idx].data) {
    const d=S.gex[idx].data;
    S.gex[idx].chart = buildGEXChart(
      document.getElementById(`ch-${idx}`), d, d.spotPrice,
      d.gammaFlip, d.callWall, d.putWall, z, S.gex[idx].chart);
  }
}

function setDZoom(z) {
  S.doom.zoom=z;
  [20,40,0].forEach(v=>{
    const btn=document.getElementById(`dz-${v}`);
    if(btn) btn.classList.toggle('active',v===z);
  });
  if(S.doom.data) renderDoomCharts(S.doom.data);
}

// â•â•â• åˆ°æœŸæ—¥é€‰æ‹©å™¨ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderExpChips(idx, all, sel) {
  const grid = document.getElementById(`exp-grid-${idx}`);
  grid.innerHTML = '';
  all.forEach(date => {
    const isSel = sel.includes(date);
    const chip = document.createElement('label');
    chip.className = `exp-chip ${isSel?'sel':''}`;
    chip.innerHTML = `<input type="checkbox" value="${date}" ${isSel?'checked':''}> ${date}`;
    chip.querySelector('input').addEventListener('change', e => {
      if (e.target.checked) { if(!S.gex[idx].selDates.includes(date)) S.gex[idx].selDates.push(date); chip.classList.add('sel'); }
      else { S.gex[idx].selDates=S.gex[idx].selDates.filter(d=>d!==date); chip.classList.remove('sel'); }
      updExpSum(idx);
    });
    grid.appendChild(chip);
  });
  updExpSum(idx);
}

function updExpSum(idx) {
  document.getElementById(`exp-sum-${idx}`).textContent = `å·²é€‰ ${S.gex[idx].selDates.length} ä¸ª`;
}

function toggleExp(idx) {
  document.getElementById(`exp-body-${idx}`).classList.toggle('open');
  document.getElementById(`exp-chev-${idx}`).classList.toggle('open');
}

function selAllExp(idx, v) {
  S.gex[idx].selDates = v ? [...S.gex[idx].allDates] : [];
  renderExpChips(idx, S.gex[idx].allDates, S.gex[idx].selDates);
}

function selThisMonth(idx) {
  const m=`${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`;
  S.gex[idx].selDates = S.gex[idx].allDates.filter(d=>d.startsWith(m));
  renderExpChips(idx, S.gex[idx].allDates, S.gex[idx].selDates);
}

function selNextMonth(idx) {
  const now=new Date();
  const m=`${now.getFullYear()}-${String(now.getMonth()+2).padStart(2,'0')}`;
  S.gex[idx].selDates = S.gex[idx].allDates.filter(d=>d.startsWith(m));
  renderExpChips(idx, S.gex[idx].allDates, S.gex[idx].selDates);
}

async function applyExp(idx) {
  const sym=document.getElementById(`sym-${idx}`).value.trim().toUpperCase();
  document.getElementById(`exp-body-${idx}`).classList.remove('open');
  document.getElementById(`exp-chev-${idx}`).classList.remove('open');
  if (sym && S.gex[idx].data) await fetchRenderGEX(idx, sym);
}

// â•â•â• æœ«æ—¥è§‚å¯Ÿ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadDoom() {
  const sym = document.getElementById('doom-sym').value.trim().toUpperCase();
  if (!sym) return alert('è¯·è¾“å…¥æ ‡çš„ä»£ç ');
  ['ov-d1','ov-d2','ov-d3'].forEach(id => showOverlay(id,'åŠ è½½ä¸­...'));
  try {
    const [doomData, ivHist] = await Promise.all([
      apiFetch(`/api/doomsday?symbol=${encodeURIComponent(sym)}`),
      apiFetch(`/api/iv-history?symbol=${encodeURIComponent(sym)}`),
    ]);
    S.doom.data = doomData;
    S.doom.ivHistory = ivHist.history || [];

    document.getElementById('dm-exp').textContent  = doomData.expirationDate||'--';
    document.getElementById('dm-spot').textContent = fp(doomData.spotPrice);
    document.getElementById('dm-flip').textContent = fp(doomData.gammaFlip);
    document.getElementById('dm-cw').textContent   = fp(doomData.callWall);
    document.getElementById('dm-pw').textContent   = fp(doomData.putWall);
    document.getElementById('dm-iv').textContent   = fiv(doomData.atmIV);
    document.getElementById('doom-upd').textContent= doomData.updatedAt;

    // é»˜è®¤é€‰ä¸­ Call Wall + Put Wall
    S.doom.selStrikes.clear();
    if (doomData.callWall) S.doom.selStrikes.add(`c:${doomData.callWall}`);
    if (doomData.putWall)  S.doom.selStrikes.add(`p:${doomData.putWall}`);

    renderIVTags(doomData);
    renderDoomCharts(doomData);
    updateSqueeze(doomData, S.doom.ivHistory);
  } catch(e) {
    ['ov-d1','ov-d2','ov-d3'].forEach(id => showOverlay(id,'é”™è¯¯: '+e.message));
    console.error(e);
  }
}

// â”€â”€ å•å…ƒâ‘ â‘¡å…±äº«æ ‡ç­¾ï¼ˆä¸¥æ ¼å¯¹é½Xè½´ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getFilteredStrikes(data) {
  let strikes = data.strikes;
  if (S.doom.zoom>0 && data.spotPrice) {
    const filtered = strikes.filter(s=>Math.abs(s.strike-data.spotPrice)<=S.doom.zoom);
    if (filtered.length >= 3) strikes = filtered;
  }
  return strikes;
}

function renderDoomCharts(data) {
  const strikes = getFilteredStrikes(data);
  S.doom.sharedLabels = strikes.map(s=>s.strike);
  renderDoom1(data, strikes);
  renderDoom2(data, strikes);  // åŒä¸€strikesæ•°ç»„ï¼ŒXè½´å®Œå…¨å¯¹é½
  renderDoom3(S.doom.ivHistory, data);
  ['ov-d1','ov-d2','ov-d3'].forEach(id=>hideOverlay(id));
}

// å•å…ƒâ‘ ï¼šå‡€GEXæŸ± + èšåˆæ›²çº¿ + MaxGEX/MinGEXæ°´å¹³è™šçº¿ + Flip + Spot + CW/PW
function renderDoom1(data, strikes) {
  if (S.doom.charts.d1) S.doom.charts.d1.destroy();
  const canvas = document.getElementById('ch-d1');
  const labels = strikes.map(s=>s.strike);
  const netGEX  = strikes.map(s=>s.netGEX/1e6);
  const aggMap={};
  data.strikes.forEach((s,i)=>{aggMap[s.strike]=data.aggregateGEX[i]/1e9;});
  const aggVals = strikes.map(s=>aggMap[s.strike]??0);

  const barColors = netGEX.map(v=>v>=0?'#00d47e99':'#f03e5299');
  const barBorder = netGEX.map(v=>v>=0?'#00d47e':'#f03e52');

  const annotations = {};
  if (data.gammaFlip!=null) {
    annotations.flip={type:'line',xMin:data.gammaFlip,xMax:data.gammaFlip,
      borderColor:'#f03e52',borderWidth:1.5,borderDash:[5,4],
      label:{display:true,content:`Flip ${fp(data.gammaFlip)}`,position:'start',
             color:'#f03e52',backgroundColor:'transparent',font:{size:9,weight:'bold'}}};
  }
  if (data.spotPrice) {
    annotations.spot={type:'line',xMin:data.spotPrice,xMax:data.spotPrice,
      borderColor:'#00d47e',borderWidth:2,
      label:{display:true,content:fp(data.spotPrice),position:'start',
             color:'#00d47e',backgroundColor:'transparent',font:{size:9,weight:'bold'}}};
  }
  if (data.callWall) {
    annotations.cw={type:'line',xMin:data.callWall,xMax:data.callWall,
      borderColor:'#00d47e60',borderWidth:1,borderDash:[4,3],
      label:{display:true,content:`CW ${data.callWall}`,position:'end',
             color:'#00d47e',backgroundColor:'transparent',font:{size:9}}};
  }
  if (data.putWall) {
    annotations.pw={type:'line',xMin:data.putWall,xMax:data.putWall,
      borderColor:'#f03e5260',borderWidth:1,borderDash:[4,3],
      label:{display:true,content:`PW ${data.putWall}`,position:'end',
             color:'#f03e52',backgroundColor:'transparent',font:{size:9}}};
  }
  // Max GEX é»„è‰²æ°´å¹³è™šçº¿
  if (data.maxGEX?.strike!=null) {
    const maxM = data.maxGEX.value/1e6;
    annotations.maxGEX={type:'line',yMin:maxM,yMax:maxM,
      borderColor:'#f5c518',borderWidth:1,borderDash:[6,3],
      label:{display:true,content:`MaxGEX@${data.maxGEX.strike} ${maxM.toFixed(1)}M`,
             position:'end',color:'#f5c518',backgroundColor:'transparent',font:{size:9}}};
  }
  // Min GEX ç´«è‰²æ°´å¹³è™šçº¿
  if (data.minGEX?.strike!=null) {
    const minM = data.minGEX.value/1e6;
    annotations.minGEX={type:'line',yMin:minM,yMax:minM,
      borderColor:'#9b6dff',borderWidth:1,borderDash:[6,3],
      label:{display:true,content:`MinGEX@${data.minGEX.strike} ${minM.toFixed(1)}M`,
             position:'end',color:'#9b6dff',backgroundColor:'transparent',font:{size:9}}};
  }

  S.doom.charts.d1 = new Chart(canvas, {
    type:'bar',
    data:{labels,datasets:[
      {label:'å‡€ GEX (M)',data:netGEX,backgroundColor:barColors,borderColor:barBorder,borderWidth:1,yAxisID:'y'},
      {label:'èšåˆ GEX (B)',data:aggVals,type:'line',yAxisID:'y2',borderColor:'#3b9eff',
       borderWidth:2,pointRadius:0,tension:0.4,fill:false},
    ]},
    options:{
      responsive:true,maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{labels:{boxWidth:12,padding:14}},
        annotation:{annotations},
        tooltip:{backgroundColor:'#111823',borderColor:'#1c2a3a',borderWidth:1,
          callbacks:{label:ctx=>{
            if(ctx.datasetIndex===1) return `èšåˆGEX: ${ctx.raw.toFixed(4)}B`;
            const s=strikes[ctx.dataIndex];
            return [`å‡€GEX: ${ctx.raw.toFixed(2)}M`,`CallOI:${(s?.callOI||0).toLocaleString()}`,`PutOI:${(s?.putOI||0).toLocaleString()}`];
          }}}
      },
      scales:{
        x:{type:'category',grid:{color:'#1c2a3a60'},
           ticks:{maxRotation:45,autoSkip:true,maxTicksLimit:25,color:'#3a4f63'}},
        y:{position:'left',grid:{color:'#1c2a3a60'},title:{display:true,text:'å‡€ GEX (M)',color:'#3a4f63'}},
        y2:{position:'right',grid:{display:false},title:{display:true,text:'èšåˆ GEX (B)',color:'#3b9eff50'},
            ticks:{color:'#3b9eff80'}},
      }
    }
  });
}

// å•å…ƒâ‘¡ï¼šVol/OI â€” ä¸å•å…ƒâ‘ å®Œå…¨ç›¸åŒçš„labelsæ•°ç»„
function renderDoom2(data, strikes) {
  if (S.doom.charts.d2) S.doom.charts.d2.destroy();
  const canvas = document.getElementById('ch-d2');
  const labels = strikes.map(s=>s.strike); // ä¸å•å…ƒâ‘ å®Œå…¨ç›¸åŒ

  const maxRatio = Math.max(...strikes.map(s=>Math.max(s.callVolOI,s.putVolOI)),0.01);

  const callBg = strikes.map(s=>{
    const i=Math.min(s.callVolOI/maxRatio,1);
    return `rgba(0,212,126,${0.15+i*0.8})`;
  });
  const putBg = strikes.map(s=>{
    const i=Math.min(s.putVolOI/maxRatio,1);
    return `rgba(240,62,82,${0.15+i*0.8})`;
  });

  const annotations={};
  if(data.spotPrice){
    annotations.spot={type:'line',xMin:data.spotPrice,xMax:data.spotPrice,
      borderColor:'#00d47e60',borderWidth:1,borderDash:[3,3]};
  }
  if(data.callWall){
    annotations.cw={type:'line',xMin:data.callWall,xMax:data.callWall,
      borderColor:'#00d47e50',borderWidth:1,borderDash:[3,3]};
  }
  if(data.putWall){
    annotations.pw={type:'line',xMin:data.putWall,xMax:data.putWall,
      borderColor:'#f03e5250',borderWidth:1,borderDash:[3,3]};
  }

  S.doom.charts.d2 = new Chart(canvas,{
    type:'bar',
    data:{labels,datasets:[
      {label:'Call Vol/OI',data:strikes.map(s=>s.callVolOI),backgroundColor:callBg,borderWidth:0},
      {label:'Put Vol/OI', data:strikes.map(s=>-s.putVolOI), backgroundColor:putBg, borderWidth:0},
    ]},
    options:{
      responsive:true,maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{labels:{boxWidth:12,padding:14}},
        annotation:{annotations},
        tooltip:{backgroundColor:'#111823',borderColor:'#1c2a3a',borderWidth:1,
          callbacks:{label:ctx=>{
            const v=Math.abs(ctx.raw);
            return `${ctx.dataset.label}: ${v.toFixed(3)}`;
          }}}
      },
      scales:{
        x:{type:'category',grid:{color:'#1c2a3a60'},
           ticks:{maxRotation:45,autoSkip:true,maxTicksLimit:25,color:'#3a4f63'}},
        y:{grid:{color:'#1c2a3a60'},title:{display:true,text:'Vol/OI',color:'#3a4f63'},
           ticks:{callback:v=>Math.abs(v).toFixed(1),color:'#7a8fa5'}},
      }
    }
  });
}

// å•å…ƒâ‘¢ï¼šæ—¥å†…IVæ›²çº¿
function renderDoom3(history, data) {
  if (S.doom.charts.d3) S.doom.charts.d3.destroy();
  const canvas = document.getElementById('ch-d3');
  if (!history || history.length < 2) { hideOverlay('ov-d3'); return; }

  const labels = history.map(h=>{
    const t=new Date(h.ts);
    return t.toLocaleTimeString('zh-CN',{hour:'2-digit',minute:'2-digit',timeZone:'America/New_York'});
  });

  const datasets=[];

  // ATM IV è“çº¿
  if (history.some(h=>h.atmIV!=null)) {
    datasets.push({
      label:'ATM IV',
      data:history.map(h=>h.atmIV),
      borderColor:'#3b9eff',borderWidth:2,pointRadius:2,tension:0.3,fill:false,
    });
  }

  // Call Wall IV ç»¿è™šçº¿
  if (S.doom.selStrikes.has(`c:${data?.callWall}`) && history.some(h=>h.cwIV!=null)) {
    datasets.push({
      label:`CW ${data.callWall} IV`,
      data:history.map(h=>h.cwIV),
      borderColor:'#00d47e',borderWidth:2,pointRadius:2,tension:0.3,fill:false,borderDash:[5,3],
    });
  }

  // Put Wall IV çº¢è™šçº¿
  if (S.doom.selStrikes.has(`p:${data?.putWall}`) && history.some(h=>h.pwIV!=null)) {
    datasets.push({
      label:`PW ${data.putWall} IV`,
      data:history.map(h=>h.pwIV),
      borderColor:'#f03e52',borderWidth:2,pointRadius:2,tension:0.3,fill:false,borderDash:[5,3],
    });
  }

  if(!datasets.length){hideOverlay('ov-d3');return;}

  S.doom.charts.d3 = new Chart(canvas,{
    type:'line',
    data:{labels,datasets},
    options:{
      responsive:true,maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{labels:{boxWidth:12,padding:14}},
        tooltip:{backgroundColor:'#111823',borderColor:'#1c2a3a',borderWidth:1,
          callbacks:{label:ctx=>`${ctx.dataset.label}: ${ctx.raw!=null?Number(ctx.raw).toFixed(2)+'%':'--'}`}}
      },
      scales:{
        x:{grid:{color:'#1c2a3a60'},ticks:{color:'#3a4f63'}},
        y:{grid:{color:'#1c2a3a60'},title:{display:true,text:'IV (%)',color:'#3a4f63'},
           ticks:{callback:v=>v!=null?v.toFixed(1)+'%':null,color:'#7a8fa5'}},
      }
    }
  });
}

// â•â•â• IV æ ‡ç­¾ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderIVTags(data) {
  const c=document.getElementById('iv-tags');
  c.innerHTML='';
  const add=(key,label,type)=>{
    const t=document.createElement('div');
    const isSel=S.doom.selStrikes.has(key);
    t.className=`iv-tag ${isSel?(type==='c'?'sc':'sp'):''}`;
    t.textContent=label;
    t.onclick=()=>{
      if(S.doom.selStrikes.has(key)){S.doom.selStrikes.delete(key);t.className='iv-tag';}
      else{S.doom.selStrikes.add(key);t.className=`iv-tag ${type==='c'?'sc':'sp'}`;}
      if(S.doom.data) renderDoom3(S.doom.ivHistory,S.doom.data);
    };
    c.appendChild(t);
  };
  if(data.callWall) add(`c:${data.callWall}`,`ğŸ“ˆ Call Wall ${data.callWall}`,'c');
  if(data.putWall)  add(`p:${data.putWall}`, `ğŸ“‰ Put Wall ${data.putWall}`, 'p');
  S.doom.customStrikes.forEach(s=>add(`c:${s}`,`â˜… ${s}`,'c'));
}

function addCustomIV() {
  const v=parseFloat(document.getElementById('iv-custom').value);
  if(isNaN(v)) return alert('è¯·è¾“å…¥æœ‰æ•ˆè¡Œæƒä»·');
  S.doom.customStrikes.add(v);
  S.doom.selStrikes.add(`c:${v}`);
  if(S.doom.data){renderIVTags(S.doom.data);renderDoom3(S.doom.ivHistory,S.doom.data);}
}

// â•â•â• Gamma Squeeze åˆ¤æ–­ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
/**
 * åˆ¤æ–­é€»è¾‘ï¼š
 * çœ‹æ¶¨æŒ¤å‹ï¼š
 *   â‘  ç°ä»·è·Call Wall â‰¤ 1%ï¼ˆæ¥è¿‘å‹åŠ›ä½ï¼Œåšå¸‚å•†å¯¹å†²å‹åŠ›å¤§ï¼‰
 *   â‘¡ Call Wallçš„IVåœ¨æœ€è¿‘3ä¸ªè®°å½•ç‚¹æŒç»­ä¸Šå‡ï¼ˆå¸‚åœºé¢„æœŸè¯¥ä½ç½®è¢«çªç ´ï¼‰
 *   â‘¢ Call Wallçš„Call Vol/OI > 0.3ï¼ˆå¤§é‡æ–°ä»“ä½æŠ¼æ³¨çªç ´ï¼‰
 *   ä¸‰æ¡ä»¶å‡æ»¡è¶³ â†’ åšå¸‚å•†è¢«è¿«å¤§é‡ä¹°å…¥æ ‡çš„å¯¹å†² â†’ å¯èƒ½å¼•å‘æ­£åé¦ˆåŠ é€Ÿä¸Šæ¶¨
 *
 * çœ‹è·ŒæŒ¤å‹ï¼š
 *   â‘  ç°ä»·è·Put Wall â‰¤ 1%
 *   â‘¡ Put Wallçš„IVåœ¨æœ€è¿‘3ç‚¹æŒç»­ä¸Šå‡
 *   â‘¢ Put Wallçš„Put Vol/OI > 0.3
 *   ä¸‰æ¡ä»¶å‡æ»¡è¶³ â†’ åšå¸‚å•†è¢«è¿«å¤§é‡å–å‡ºæ ‡çš„å¯¹å†² â†’ å¯èƒ½å¼•å‘åŠ é€Ÿä¸‹è·Œ
 */
function updateSqueeze(data, history) {
  const check=(wall, wallType, ivKey, voiKey, sigEl, detEl, dir)=>{
    if(!wall||!data.spotPrice){sigEl.textContent='æ•°æ®ä¸è¶³';return;}
    const dist=Math.abs((wall-data.spotPrice)/data.spotPrice*100);
    const c1=dist<=1;
    const wStrike=data.strikes.find(s=>s.strike===wall);
    const voi=wStrike?wStrike[voiKey]:0;
    const c3=voi>0.3;
    let c2=false;
    if(history&&history.length>=3){
      const last3=history.slice(-3).map(h=>h[ivKey]);
      c2=last3[0]!=null&&last3[1]!=null&&last3[2]!=null&&last3[0]<last3[1]&&last3[1]<last3[2];
    }
    const score=[c1,c2,c3].filter(Boolean).length;
    const msgs={3:'ğŸ”´ é«˜é£é™© â€” ä¸‰æ¡ä»¶æ»¡è¶³ï¼ŒæŒ¤å‹éšæ—¶å¯èƒ½çˆ†å‘',2:'ğŸŸ¡ ä¸­ç­‰é£é™© â€” ä¸¤æ¡ä»¶æ»¡è¶³',1:'âšª ä½é£é™© â€” ä»…ä¸€æ¡ä»¶æ»¡è¶³',0:'ğŸŸ¢ æ— ä¿¡å·'};
    const colors={3:'var(--red)',2:'var(--yellow)',1:'var(--t2)',0:'var(--green)'};
    sigEl.textContent=msgs[score];
    sigEl.style.color=colors[score];
    detEl.innerHTML=`â‘ è·${wallType} Wall(${wall}): ${dist.toFixed(2)}% ${c1?'âœ“':'âœ—'}<br>â‘¡IVæŒç»­ä¸Šå‡(è¿‘3æœŸ): ${c2?'âœ“':'âœ—'}<br>â‘¢Vol/OI(${voi.toFixed(2)}>0.3): ${c3?'âœ“':'âœ—'}`;
  };
  check(data.callWall,'Call','cwIV','callVolOI',document.getElementById('sq-up'),document.getElementById('sq-up-d'),'up');
  check(data.putWall, 'Put', 'pwIV','putVolOI', document.getElementById('sq-dn'),document.getElementById('sq-dn-d'),'dn');
}

// â•â•â• è‡ªåŠ¨åˆ·æ–°ï¼ˆå¸‚åœºæ—¶é—´å†…æ¯15åˆ†é’Ÿï¼‰ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
setInterval(async()=>{
  const et=new Date(new Date().toLocaleString('en-US',{timeZone:'America/New_York'}));
  const d=et.getDay(),m=et.getHours()*60+et.getMinutes();
  if(!(d>=1&&d<=5&&m>=510&&m<960)) return;
  for(const idx of [1,2]){
    const sym=document.getElementById(`sym-${idx}`).value.trim().toUpperCase();
    if(sym&&S.gex[idx].data) fetchRenderGEX(idx,sym).catch(console.error);
  }
  const dsym=document.getElementById('doom-sym').value.trim().toUpperCase();
  if(dsym&&S.doom.data) loadDoom().catch(console.error);
}, 15*60*1000);

// â•â•â• å›è½¦å¿«æ·é”® â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('sym-1').addEventListener('keydown',e=>{if(e.key==='Enter')loadGEX(1);});
  document.getElementById('sym-2').addEventListener('keydown',e=>{if(e.key==='Enter')loadGEX(2);});
  document.getElementById('doom-sym').addEventListener('keydown',e=>{if(e.key==='Enter')loadDoom();});
});
</script>
</body>
</html>
